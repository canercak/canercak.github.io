<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Caner's Ruby on rails blog]]></title>
  <link href="http://canercak.github.io/atom.xml" rel="self"/>
  <link href="http://canercak.github.io/"/>
  <updated>2014-04-09T03:04:41+03:00</updated>
  <id>http://canercak.github.io/</id>
  <author>
    <name><![CDATA[Caner]]></name>
    <email><![CDATA[canercak@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth, Facebook, Koala and Resque]]></title>
    <link href="http://canercak.github.io/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala/"/>
    <updated>2014-02-03T22:37:12+02:00</updated>
    <id>http://canercak.github.io/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala</id>
    <content type="html"><![CDATA[<p>Data is the key to long-lasting relationship with users. The more, the better. Once we have relevant data;
we can target marketing, develop features tailored to specific users and make users trust each other.
So how do we collect relevant data? There is an easy way. It&rsquo;s Facebook.</p>

<p>First, talk with your solicitor to add your Terms&amp;Conditions document that you are collecting data by using facebook.
Then make a big &ldquo;Login with Facebook&rdquo; button on your landing page. Don&rsquo;t forget to write that the user accepts the conditions
once the button clicked. Something like this:</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_044.png"></p>

<p>Then you are ready to go. I use three gems to collect data:
omniauth, omniauth-facebook and koala. For config settings there is simple config and for caching data I use resque.
I know that using devise could be easier. But simply, its big.(I have omniauth-identity for nonfacebook logins)
So this will be different than devise&rsquo;s way.</p>

<p>Here we define our facebook app details. Sensitive data is stored on local.rb file and Simpleconfig serves them to environments. Checkout simpleconfig for details.</p>

<figure class='code'><figcaption><span>config/settings/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleConfig</span><span class="o">.</span><span class="n">for</span> <span class="ss">:application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">group</span> <span class="ss">:facebook</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:namespace</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_NAMESPACE&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_id</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_APP_ID&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_secret</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_SECRET&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:scope</span><span class="p">,</span> <span class="s1">&#39;email, publish_stream, user_birthday, user_about_me, user_education_history, user_interests, user_likes, user_religion_politics, user_work_history&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:cache_expiry_time</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="n">days</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are omniauth initialisation details. You can learn more about omniauth on it&rsquo;s github page.</p>

<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>    <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>    <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The haml view for our big facebook button.</p>

<figure class='code'><figcaption><span>views/pages/_facebook_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>
</span><span class='line'><span class="nc">.hidden-phone</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">link_to</span> <span class="n">auth_at_provider_path</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="ss">:facebook</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-large btn-facebook&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon-facebook-sign.icon-large</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_with_facebook&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nt">%p</span><span class="nc">.signin-terms</span>
</span><span class='line'>  <span class="nt">%b</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;we_will_never_post&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nt">%br</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;pages.home.signin_terms&#39;</span><span class="p">,</span> <span class="ss">appname</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">terms_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;terms&#39;</span><span class="p">),</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}),</span> <span class="n">policy_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;policy&#39;</span><span class="p">),</span> <span class="ss">:policy</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">html_safe</span>
</span></code></pre></td></tr></table></div></figure>


<p>Necassary routes to manage sessions</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Sessions</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#new&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:auth_at_provider</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider/callback&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#create&#39;</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/failure&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;signout&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the user model. Removed the nonrelevant fields. As you can see I&rsquo;m collecting enough data to make decisions.</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="ss">Concerns</span><span class="p">:</span><span class="ss">:User</span><span class="o">::</span><span class="no">Authentication</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="ss">Concerns</span><span class="p">:</span><span class="ss">:User</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:provider</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:uid</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_token</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_expires_at</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_permissions</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_friends</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_favorites</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">DateTime</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">&#39;2014-01-01&#39;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:gender</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:bio</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:languages</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:birthday</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:work</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:education</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_verified</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the module for facebook authentication. This will collect facebook user data before saving the user.</p>

<figure class='code'><figcaption><span>app/models/concerns/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Authentication</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_fields_from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>          <span class="n">set_credentials</span> <span class="n">auth</span><span class="o">.</span><span class="n">credentials</span>
</span><span class='line'>          <span class="n">set_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">info</span>
</span><span class='line'>          <span class="n">set_extra_raw_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>          <span class="n">set_extra_raw_info_special_permissions</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>          <span class="n">set_permissions</span>
</span><span class='line'>          <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FacebookDataCacher</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="ss">Redis</span><span class="p">:</span><span class="ss">:CannotConnectError</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="kp">private</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">oauth_expires_at</span> <span class="o">=</span>  <span class="no">Time</span><span class="o">.</span><span class="n">at</span> <span class="n">credentials</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">||</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">facebook_verified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">verified</span> <span class="o">||</span> <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_extra_raw_info</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">bio</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">languages</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_extra_raw_info_special_permissions</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">birthday</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span><span class="p">,</span> <span class="s2">&quot;%m/%d/%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">at_midnight</span> <span class="k">if</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">work</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">education</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">education</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_permissions</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">facebook_permissions</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;permissions&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>          <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>          <span class="n">user</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module is for caching data. I&rsquo;m making resque collect more and more details.
We will run resque workers to get them.
You can also schedule the process with resque scheduler.
Checkout facebook graph api for more data to get.
And checkout resque gem for details.</p>

<figure class='code'><figcaption><span>app/models/concerns/facebook.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Facebook</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>          <span class="vi">@facebook</span> <span class="o">||=</span> <span class="ss">Koala</span><span class="p">:</span><span class="ss">:Facebook</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">block_given?</span> <span class="p">?</span> <span class="k">yield</span><span class="p">(</span><span class="vi">@facebook</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@facebook</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="ss">Koala</span><span class="p">:</span><span class="ss">:Facebook</span><span class="o">::</span><span class="no">APIError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">has_facebook_permission?</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>           <span class="n">facebook_permissions</span><span class="o">[</span><span class="n">scope</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">facebook_permissions?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">cache_facebook_data?</span>
</span><span class='line'>          <span class="n">favorites</span> <span class="o">=</span> <span class="sx">%w(music books movies television games activities interests)</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch_api</span><span class="o">|</span>
</span><span class='line'>              <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;friends&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="n">favorites</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">favorite</span><span class="o">|</span>
</span><span class='line'>                <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">favorite</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>               <span class="nb">self</span><span class="o">.</span><span class="n">facebook_friends</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_favorites</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">flatten</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="k">return</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a resque worker to cache facebook data.</p>

<figure class='code'><figcaption><span>app/workers/facebook_data_cacher.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FacebookDataCacher</span>
</span><span class='line'>  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:facebook_cache_data_queue</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="n">user_id</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">facebook_data_cached_at</span> <span class="o">&lt;</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">cache_expiry_time</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">cache_facebook_data?</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we go. The code above will get us the data we defined on our model and it will be updating and adding more data when user logins.
Now it&rsquo;s time to make decisions!!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating Activity Cal-heatmap Using Public_activity and Mongoid]]></title>
    <link href="http://canercak.github.io/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/"/>
    <updated>2013-08-02T16:52:00+03:00</updated>
    <id>http://canercak.github.io/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/47336405/Selection_043.png" title="" ></p>

<p>I had to present activites of a service provider to it&rsquo;s users in a unique way.
First thought of creating an activity stream but knew that the users won&rsquo;t be
reading them since the activity would be about the services of the provider- not something &ldquo;social&rdquo;.
Then thought of creating a line graph that shows the days and works done by the provider. It wouldn&rsquo;t be unique though.
I thought and thought by looking at my github dashboard and idea came up. I always liked Github&rsquo;s collaboration heatmap.
It was unique and concise. So I decided to create my own activity heatmap.</p>

<p>I needed to sort out three things in order to make it happen.</p>

<p>Finding out a github-like heatmap to present activities
Logging provider activites in a way that I can present on map
Making mongoid and Rails 4 work with heatmap and activity logs.</p>

<p>Here is how I created my activity heatmap:</p>

<p>Kamisama has done great job on creating cal-heatmaps. Its obvious that github uses his work too. You can find his work on
<a href="https://github.com/kamisama/cal-heatmap.">https://github.com/kamisama/cal-heatmap.</a> You have to download cal-heatmap.js, d3.js and for localisation; moment.js does great job.
I had to present three activites to user;</p>

<p>When provider gets selected by user.
When provider returns to quote
When provider does the work</p>

<p>You cannot divide the activities to parts in cal-heatmap.
You provide timestamps with numeric values and cal-heatmap shows the data.
So I first had to fetch these three activities, count them and show them on map.
Then I would present the details once the user clicks on a cell.
So &ldquo;get_provider_counts&rdquo; counts the data in a way cal-heatmap understands,
&ldquo;get_activity gets&rdquo; the data once I click on a cell.</p>

<figure class='code'><figcaption><span>providers.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">initProviderShow = </span><span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span>
</span><span class='line'>    <span class="nv">url: </span><span class="s">&quot;/activities/get_provider_counts&quot;</span>
</span><span class='line'>    <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>    <span class="nv">data:</span>
</span><span class='line'>      <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>    <span class="nv">dataType: </span><span class="s">&quot;json&quot;</span>
</span><span class='line'>    <span class="p">).</span><span class="nx">success</span> <span class="nf">(data) -&gt;</span>
</span><span class='line'>    <span class="nx">moment</span><span class="p">.</span><span class="nx">lang</span> <span class="s">&quot;en&quot;</span>
</span><span class='line'>    <span class="nv">calendar = </span><span class="k">new</span> <span class="nx">CalHeatMap</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">calendar</span><span class="p">.</span><span class="nx">init</span>
</span><span class='line'>      <span class="nv">itemSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat&quot;</span>
</span><span class='line'>      <span class="nv">data: </span><span class="nx">data</span>
</span><span class='line'>      <span class="nv">start: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">domain: </span><span class="s">&quot;month&quot;</span>
</span><span class='line'>      <span class="nv">subDomain: </span><span class="s">&quot;day&quot;</span>
</span><span class='line'>      <span class="nv">range: </span><span class="mi">7</span>
</span><span class='line'>      <span class="nv">cellSize: </span><span class="mi">15</span>
</span><span class='line'>      <span class="nv">cellPadding: </span><span class="mi">5</span>
</span><span class='line'>      <span class="nv">domainGutter: </span><span class="mi">20</span>
</span><span class='line'>      <span class="nv">displayScale: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">previousSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-PreviousDomain-selector&quot;</span>
</span><span class='line'>      <span class="nv">nextSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-NextDomain-selector&quot;</span>
</span><span class='line'>      <span class="nv">domainLabelFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s">&quot;MMMM&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">subDomainDateFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span> <span class="s">&quot;LL&quot;</span>
</span><span class='line'>      <span class="nv">subDomainTitleFormat:</span>
</span><span class='line'>        <span class="nv">empty: </span><span class="s">&quot;{date} +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">no_activites</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">        filled: &quot;</span><span class="p">{</span><span class="nx">date</span><span class="p">}</span>  <span class="p">{</span><span class="nx">count</span><span class="p">}</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.has_activites&quot;</span>
</span><span class='line'>      <span class="nv">onClick: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
</span><span class='line'>          <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/activities/get_activity&quot;</span>
</span><span class='line'>          <span class="nv">data: </span><span class="p">{</span> <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nv">selected: </span><span class="nx">date</span><span class="p">}</span>
</span><span class='line'>          <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>            <span class="nv">text1= </span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="nx">text2</span> <span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="nv">text3 = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nv">text1 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.selected</span>
</span><span class='line'><span class="s">            if data.returned &gt; 0</span>
</span><span class='line'><span class="s">              text2 = data.returned + &quot;</span> <span class="s">&quot; +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">returned</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nv">text3 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.done&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">text1</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text2</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text3</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="nx">text1</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text2</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text3</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">error: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>      <span class="nv">legend: </span><span class="p">[</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'>        <span class="mi">3</span>
</span><span class='line'>        <span class="mi">5</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>      <span class="nv">legendColors: </span><span class="p">[</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="err">#</span><span class="s">ecf5e2&quot;</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="err">#</span><span class="s">232181&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>  <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was about to store provider activities myself but then found a great gem to sort it out.
Its public_activity gem. <a href="https://github.com/pokonski/public_activity">https://github.com/pokonski/public_activity</a>
It&rsquo;s quote comprehensve and does support mongoid and Rails 4.</p>

<p>The system I&rsquo;m working on is about User creating quotes to providers.
For every quote user selects up to three providers. Provider &ldquo;returns&rdquo; back to quote and
if agrees with user, provider &ldquo;does&rdquo; the work.
So I&rsquo;m tracking the user, relation to providers collection, returned providers and providerdone.</p>

<figure class='code'><figcaption><span>Quote.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;autoinc&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Quote</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Paranoia</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Slug</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Autoinc</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Geocoder</span><span class="p">:</span><span class="ss">:Model</span><span class="o">::</span><span class="no">Mongoid</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Concerns</span><span class="p">:</span><span class="ss">:GmapRoute</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Model</span>
</span><span class='line'>  <span class="n">tracked</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">tracked</span> <span class="ss">:params</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">:returned_providers</span> <span class="o">=&gt;</span> <span class="ss">:returned_providers</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:providerdone</span> <span class="o">=&gt;</span> <span class="ss">:providerdone</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:providers</span> <span class="o">=&gt;</span> <span class="ss">:provider_ids</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I created a controller to store activities. Our system does not have activity streams
so this will be useful for new features too.
These two methods are for ajax requests I explained above.</p>

<figure class='code'><figcaption><span>activities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">get_provider_counts</span>
</span><span class='line'>    <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@activities</span> <span class="o">=</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">seldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">retdata</span> <span class="o">=</span><span class="p">{}</span>
</span><span class='line'>    <span class="n">donedata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">selected_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">seldata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">returned_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">retdata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">done_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">donedata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="n">donedata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">retdata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seldata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">to_json</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_activity</span>
</span><span class='line'>    <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:selected</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@activities</span> <span class="o">=</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:selected</span><span class="o">=&gt;</span> <span class="n">selected_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:returned</span> <span class="o">=&gt;</span><span class="n">returned_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:done</span><span class="o">=&gt;</span><span class="n">done_providers</span><span class="o">.</span><span class="n">count</span><span class="p">}}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Finally the view to show cal-heatmap</p>

<figure class='code'><figcaption><span>providers/show.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nt">%div</span>
</span><span class='line'>  <span class="nf">#calheat</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;position:relative;&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%p</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-PreviousDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-left</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-NextDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-right</span>
</span><span class='line'>  <span class="nt">%h5</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span><span class="s2">&quot;text-align: center;margin-top: -10px;&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="nf">#onClick-placeholder</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Two Factor Authentication Using Active_model_otp With Mongoid]]></title>
    <link href="http://canercak.github.io/blog/2011/07/03/two-factor-authentication-using-active-model-otp-with-mongoid/"/>
    <updated>2011-07-03T05:59:00+03:00</updated>
    <id>http://canercak.github.io/blog/2011/07/03/two-factor-authentication-using-active-model-otp-with-mongoid</id>
    <content type="html"><![CDATA[<p>I had to implement two factor authentication using a custom sms provider.
Active model OTP really helped me in generating one time use tokens.
I thought it won&rsquo;t be working with mongoid but it was easy to integrate it.
Another issue was to make user authenticated on the same page.
We just didn&rsquo;t want to direct user to another page for phone verification.
So I&rsquo;ve written some js to sort it out. It&rsquo;s a bit &ldquo;manual&rdquo; because clientsidevalidations caused problems in Rails4.
Everything gets validated both on client and server side.
Here you can see relevant parts from the code.</p>

<div><script src='https://gist.github.com/9946621.js'></script>
<noscript><pre><code>def check_verification_code
      data = {:result =&gt; false}
      if current_user.authenticate_otp(params[:verification_code], drift: 200) #drift enough for old users 
        data = {:result =&gt; true}
        session[:mobile_verified] = true
      end
      respond_to do |format|
        format.json  { render :json =&gt; data} 
      end
    end


    def sendverification
      data = {:result =&gt; false} 
      phone = validate_phone(params[:verification_phone])
      if phone.present?
        sms = Sms.new       
        if sms.send_sms([phone],APP_CONFIG.sms_from, t(&#39;verification_message&#39;) + current_user.otp_code.to_s)
          data = {:result =&gt; true} 
        end
      end
      respond_to do |format|
        format.json  { render :json =&gt; data} 
      end
    end


</code></pre></noscript></div>



]]></content>
  </entry>
  
</feed>
