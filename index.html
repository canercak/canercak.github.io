
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Caner's Ruby on rails blog</title>
  <meta name="author" content="Caner Cakmak">

  
  <meta name="description" content="Been 4-5 years since I started developing Ruby on Rails and I just don&rsquo;t remember using tree views.
Used them a lot in .NET development but &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://canercak.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Caner's Ruby on rails blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Caner's Ruby on rails blog</a></h1>
  
    <h2>It's all about the beauty of Ruby. I'm not a "Guru", not a "Rock Star" or "Ninja" at all. But I can do every single thing I need and I enjoy so much because I'm in love with her beauty</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:canercak.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/18/fancy-return-to-old-school-trees/">Fancy Return to Old School Trees</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-18T23:36:40+03:00" pubdate data-updated="true">Jul 18<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Been 4-5 years since I started developing Ruby on Rails and I just don&rsquo;t remember using tree views.
Used them a lot in .NET development but somehow did not after that. This reminds me the KISS principle actually.
I guess Rails with Bootstrap forms and components make us present collective data in a simple manner so we don&rsquo;t tend to
use treeviews to present things &ldquo;all-in-one&rdquo;.</p>

<p>By the way for the case I will explain now, I didn&rsquo;t use a treeview at first actually. I used select2.
I had to make a company official to select the services they offer to customers. Services had 4-level categories
and the lowest level had multiple variations. When I think of the word &ldquo;select&rdquo; in Rails, I instantly remember my friend
Select2. I feed the JSON, Select2 presents and makes the user select things.
However in this case user had to select services from ever growing thousand of services. He had to view all categories at once (obviously the top ones first),
he had to filter them and for sure he had to select multiples of services.</p>

<p>Created the JSON data at first and remotely fed it to Select2. User could see the categories, filter them and select.
Things seemed right first however there was a catch.</p>

<p>Think of google. You want to search for a wikipedia article but just can&rsquo;t find it with the keywords you write -even google has exceptional capabilities to do that.
Then you go to wikipedia, find a related category and you reach to the article by looking at its parent or child categories.
You even remember to check other categories once you see them in a a categorized list.
This was the case for selecting services. When using select2 user could filter the services he is offering and would definitely reach to them,
however he would never see the &ldquo;map&rdquo; of those thousands of categories and for sure he would not include the exact services he was offering.
I knew this could undermine the user experience so I returned to my old school friend treeview.</p>

<p>Not being mad to create mine, I had to find a js based treeview component which is free and has JSON, checkbox, selection, filtering and responsive functionality.
First checked out the popular jstree however it was useless since selecting a node would check all the child nodes.
Then after extensive research bumped up to Fancytree. It really had an ugly asp style demo page so I had some prejudice first. However once I would &ldquo;get it&rdquo;
I understood that it&rsquo;s was exceptionally well-done. I now have great respect to it.</p>

<p>Here is the result</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_002.png"></p>

<p>And here is how I used it:</p>

<p>For embedding fancytree goto <a href="https://github.com/mar10/fancytree/wiki">https://github.com/mar10/fancytree/wiki</a></p>

<p>Basically you have include the actual js and css. If you use bootstrap include the glyph extension too.
Here is how I used FancyTree. It has checkbox and filtering functionality with highlighting and selection
unique to my taste.</p>

<p>You can also see some parts that contradict the DRY principle &ndash; sorry but this was the first version to see
things are working and I felt the urge to post it. I usually write the code with simple tests first to see things working,
then refactor the it with better tests and DRY everything before production. So change things as you want.</p>

<figure class='code'><figcaption><span>provider.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">tree&quot;</span><span class="p">).</span><span class="nx">fancytree</span>
</span><span class='line'>      <span class="nv">activeVisible: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">aria: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">autoActivate: </span><span class="kc">true</span>
</span><span class='line'>      <span class="c1">#autoCollapse: true  </span>
</span><span class='line'>      <span class="nv">autoScroll: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">clickFolderMode: </span><span class="mi">3</span>
</span><span class='line'>      <span class="nv">checkbox: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">debugLevel: </span><span class="mi">0</span>
</span><span class='line'>      <span class="nv">disabled: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">generateIds: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">idPrefix: </span><span class="s">&quot;ft_&quot;</span>
</span><span class='line'>      <span class="nv">icons: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">keyboard: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">keyPathSeparator: </span><span class="s">&quot;/&quot;</span>
</span><span class='line'>      <span class="nv">minExpandLevel: </span><span class="mi">1</span>
</span><span class='line'>      <span class="nv">selectMode: </span><span class="mi">3</span>
</span><span class='line'>      <span class="nv">tabbable: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">titlesTabbable: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">strings: </span>
</span><span class='line'>          <span class="nv">loading: </span><span class="s">&quot;yükleniyor...&quot;</span>
</span><span class='line'>          <span class="nv">loadError: </span><span class="s">&quot;yükleme başarısız&quot;</span> 
</span><span class='line'>      <span class="nv">extensions: </span><span class="p">[</span>
</span><span class='line'>          <span class="s">&quot;filter&quot;</span>
</span><span class='line'>          <span class="s">&quot;glyph&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>      <span class="nv">filter:</span>
</span><span class='line'>          <span class="nv">mode: </span><span class="s">&quot;dim&quot;</span>
</span><span class='line'>      <span class="nv">source:</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/categories/get_allcategories&quot;</span>
</span><span class='line'>          <span class="nv">data:</span>
</span><span class='line'>              <span class="nv">provider_id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">cache: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">onPostInit: </span><span class="nf">-&gt;</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@getSelectedNodes</span><span class="p">(),</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">makeVisible</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="nv">select: </span><span class="nf">(e, data) -&gt;</span>
</span><span class='line'>          <span class="nv">selKeys = </span><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">getSelectedNodes</span><span class="p">(),</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">key</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">echoSelection3&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">selKeys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">selRootNodes = </span><span class="nx">data</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">getSelectedNodes</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">selRootKeys = </span><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">selRootNodes</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">key</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">echoSelectionRootKeys3&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">selRootKeys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="nv">click: </span><span class="nf">(event, data) -&gt;</span>
</span><span class='line'>          <span class="nv">node = </span><span class="nx">data</span><span class="p">.</span><span class="nx">node</span>
</span><span class='line'>          <span class="nv">tt = </span><span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">fancytree</span><span class="p">.</span><span class="nx">getEventTargetType</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="nx">tt</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
</span><span class='line'>              <span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>              <span class="nv">c1 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>              <span class="k">if</span> <span class="nx">c1</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span> <span class="nx">c1</span><span class="p">,</span> <span class="nf">(index, v1) -&gt;</span>
</span><span class='line'>                      <span class="nx">v1</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>                      <span class="nv">c2 = </span><span class="nx">v1</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>                      <span class="k">if</span> <span class="nx">c2</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>                          <span class="nx">$</span><span class="p">.</span><span class="nx">each</span> <span class="nx">c2</span><span class="p">,</span> <span class="nf">(index, v2) -&gt;</span>
</span><span class='line'>                              <span class="nx">v2</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>                              <span class="nv">c3 = </span><span class="nx">v2</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>                              <span class="k">if</span> <span class="nx">c3</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>                                  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span> <span class="nx">c3</span><span class="p">,</span> <span class="nf">(index, v3) -&gt;</span>
</span><span class='line'>                                      <span class="nx">v3</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>                                      <span class="nv">c4 = </span><span class="nx">v3</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>                                      <span class="k">if</span> <span class="nx">c4</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>                                          <span class="nx">$</span><span class="p">.</span><span class="nx">each</span> <span class="nx">c4</span><span class="p">,</span> <span class="nf">(index, v4) -&gt;</span>
</span><span class='line'>                                              <span class="nx">v4</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>                                      <span class="k">else</span>
</span><span class='line'>                                          <span class="k">if</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">extraClasses</span> <span class="o">is</span> <span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                                               <span class="nv">v3.extraClasses = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>                                          <span class="k">else</span>
</span><span class='line'>                                              <span class="nv">v3.extraClasses = </span><span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                                      <span class="k">return</span>
</span><span class='line'>                              <span class="k">else</span>
</span><span class='line'>                                  <span class="k">if</span> <span class="nx">v2</span><span class="p">.</span><span class="nx">extraClasses</span> <span class="o">is</span> <span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                                       <span class="nv">v2.extraClasses = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>                                  <span class="k">else</span>
</span><span class='line'>                                      <span class="nv">v2.extraClasses = </span><span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                              <span class="k">return</span>
</span><span class='line'>                      <span class="k">else</span>
</span><span class='line'>                          <span class="k">if</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">extraClasses</span> <span class="o">is</span> <span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                               <span class="nv">v1.extraClasses = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>                          <span class="k">else</span>
</span><span class='line'>                              <span class="nv">v1.extraClasses = </span><span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                      <span class="k">return</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                  <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">extraClasses</span> <span class="o">is</span> <span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                       <span class="nv">data.node.extraClasses = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>                  <span class="k">else</span>
</span><span class='line'>                      <span class="nv">data.node.extraClasses = </span><span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">rootnode = </span><span class="kc">undefined</span>
</span><span class='line'>  <span class="nv">tree = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">tree&quot;</span><span class="p">).</span><span class="nx">fancytree</span><span class="p">(</span><span class="s">&quot;getTree&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nv">n = </span><span class="kc">undefined</span>
</span><span class='line'>      <span class="nv">leavesOnly = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">leavesOnly&quot;</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">match = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">e</span> <span class="o">and</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">.</span><span class="nx">ESCAPE</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">()</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">regex&quot;</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">n = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">filterNodes</span><span class="p">(</span><span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">).</span><span class="nx">test</span> <span class="nx">node</span><span class="p">.</span><span class="nx">title</span>
</span><span class='line'>          <span class="p">,</span> <span class="nx">leavesOnly</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nv">n = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">filterNodes</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">leavesOnly</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;span</span><span class="err">#</span><span class="s">matches&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="s">&quot; eşleşme bulundu)&quot;</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">focus</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">val</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;span</span><span class="err">#</span><span class="s">matches&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">hideMode&quot;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nv">tree.options.filter.mode = </span><span class="p">(</span><span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="s">&quot;hide&quot;</span> <span class="k">else</span> <span class="s">&quot;dimm&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;checked&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">leavesOnly&quot;</span><span class="p">).</span><span class="nx">change</span> <span class="nf">(e) -&gt;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1"># tree.options.filter.leavesOnly = $(this).is(&quot;:checked&quot;);</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">regex&quot;</span><span class="p">).</span><span class="nx">change</span> <span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>controller to feed JSON data</p>

<figure class='code'><figcaption><span>categories_controller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">get_allcategories</span>
</span><span class='line'>    <span class="n">provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:provider_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">categories</span> <span class="o">=</span>  <span class="no">Category</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">}</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span><span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>JSON list of categories with provider&rsquo;s categories selected</p>

<figure class='code'><figcaption><span>category_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">describe</span> <span class="no">Category</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:provider</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:price</span><span class="p">,</span> <span class="n">variation_id</span><span class="p">:</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">workdone</span><span class="o">.</span><span class="n">provider</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:categories</span><span class="p">)</span> <span class="p">{</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_categories</span><span class="p">(</span><span class="kp">true</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">describe</span> <span class="s2">&quot;#list_provider_categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should return list of all categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should mark provider&#39;s categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">[</span><span class="ss">:selected</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>category.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">variation_ids</span><span class="p">,</span><span class="n">category_ids</span><span class="p">,</span><span class="n">related_categories</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span><span class="o">[]</span><span class="p">,</span><span class="o">[]</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>      <span class="n">variation_ids</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">category_ids</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&quot;prices.active&quot;</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:category_id</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span>
</span><span class='line'>      <span class="n">related_categories</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">find_parent_related</span><span class="p">(</span><span class="n">category_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">grand_parents</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">parents</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">childrens</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">babies</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">Jbuilder</span><span class="o">.</span><span class="n">encode</span> <span class="k">do</span> <span class="o">|</span><span class="n">json</span><span class="o">|</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">array!</span> <span class="n">grand_parents</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">grand_parent</span><span class="o">|</span>
</span><span class='line'>        <span class="n">gp_id</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:title</span><span class="o">=&gt;</span><span class="n">grand_parent</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">grand_parent</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">gp_id</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">gp_id</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">grand_parent</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">parents</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">parent</span><span class="o">|</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">parent</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">parent</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">parent</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">parent</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">childrens</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">child</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">child</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">child</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">child</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">babies</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">baby</span><span class="o">|</span>
</span><span class='line'>              <span class="n">variations</span> <span class="o">=</span> <span class="n">baby</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">variations</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">baby</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">baby</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">category_ids</span><span class="o">.</span><span class="n">include?</span> <span class="n">baby</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">children</span> <span class="n">variations</span> <span class="k">do</span> <span class="o">|</span><span class="n">variation</span><span class="o">|</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">baby</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">variation</span><span class="o">.</span><span class="n">variation</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">variation_ids</span><span class="o">.</span><span class="n">include?</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">selected</span> <span class="kp">true</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">extraClasses</span> <span class="s2">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">selected</span> <span class="kp">false</span>
</span><span class='line'>                <span class="k">end</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The logic to update categories</p>

<figure class='code'><figcaption><span>provider.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">assign_workdones</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selected_variations</span> <span class="o">=</span> <span class="no">ApplicationController</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">selected_variations</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">active_variations</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">inactive_variations</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>       <span class="nb">self</span><span class="o">.</span><span class="n">assign_new_workdone</span><span class="p">(</span><span class="n">selected_variations</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">active_variations</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">inactive_variations</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">false</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">variations_to_deactivate</span> <span class="o">=</span> <span class="p">(</span><span class="n">active_variations</span> <span class="o">+</span> <span class="n">inactive_variations</span><span class="p">)</span> <span class="o">-</span> <span class="n">selected_variations</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span> <span class="k">if</span> <span class="n">variations_to_deactivate</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span><span class="p">)}}</span>
</span><span class='line'>      <span class="n">selected_variations</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">var</span><span class="o">|</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!</span><span class="n">active_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">inactive_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">assign_new_workdone</span><span class="p">(</span><span class="o">[</span><span class="n">var</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elsif</span> <span class="o">!</span><span class="n">active_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">inactive_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="n">price</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&quot;prices.variation_id&quot;</span><span class="o">=&gt;</span> <span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="n">price</span><span class="o">.</span><span class="n">to_a</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>tests for assigning workdones</p>

<figure class='code'><figcaption><span>provider_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#assign_workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:new_categories</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">_id</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories include current categories and more categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:max_categories</span><span class="p">)</span> <span class="p">{</span> <span class="mi">25</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">_id</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:result</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span> <span class="o">+</span> <span class="n">current_categories</span><span class="p">}</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:max_result</span><span class="p">)</span> <span class="p">{</span> <span class="n">max_categories</span> <span class="o">+</span> <span class="n">current_categories</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should create active workdones from new categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">initial_workdone_count</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories does not include the current categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:result</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should deactivate the categories that are not in the result array&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories include inactive workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:array_to_assign</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should activate the inactive workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">array_to_assign</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">current_categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>helper method to parse categories</p>

<figure class='code'><figcaption><span>providers_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">selected_variations</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>   <span class="n">all_variations</span> <span class="o">=</span> <span class="n">categories</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">]</span><span class="p">}}}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>   <span class="n">selected_variations</span> <span class="o">=</span> <span class="n">all_variations</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="no">Moped</span><span class="o">::</span><span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">c</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;selected&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">selected_variations</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-20T21:06:29+02:00" pubdate data-updated="true">Mar 20<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Data is the key to long-lasting relationship with users. The more, the better. Once we have relevant data; we can target marketing, develop features tailored to specific users and make users trust each other. So how do we collect relevant data? There is an easy way. It’s Facebook.</p>

<p>First, talk with your solicitor to add your Terms&amp;Conditions document that you are collecting data by using facebook. Then make a big “Login with Facebook” button on your landing page. Don’t forget to write that the user accepts the conditions once the button clicked. Something like this:</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_044.png"></p>

<p> Then you are ready to go. I use three gems to collect data: omniauth, omniauth-facebook and koala. For config settings there is simple config and for caching data I use resque. I know that using devise could be easier. But simply, its big.(I have omniauth-identity for nonfacebook logins) So this will be different than devise’s way.</p>

<p>Here we define our facebook app details. Sensitive data is stored on local.rb file and Simpleconfig serves them to environments. Checkout simpleconfig for details.</p>

<figure class='code'><figcaption><span>config/settings/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleConfig</span><span class="o">.</span><span class="n">for</span> <span class="ss">:application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">group</span> <span class="ss">:facebook</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:namespace</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_NAMESPACE&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_id</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_APP_ID&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_secret</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_SECRET&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:scope</span><span class="p">,</span> <span class="s1">&#39;email, publish_stream, user_birthday, user_about_me, user_education_history, user_interests, user_likes, user_religion_politics, user_work_history&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:cache_expiry_time</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="n">days</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are omniauth initialization details. You can learn more about omniauth on it’s github page.</p>

<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The haml view for our big facebook button.</p>

<figure class='code'><figcaption><span>views/pages/_facebook_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>
</span><span class='line'>  <span class="nc">.hidden-phone</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">auth_at_provider_path</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="ss">:facebook</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-large btn-facebook&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>      <span class="nt">%i</span><span class="nc">.icon-facebook-sign.icon-large</span>
</span><span class='line'>      <span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_with_facebook&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nt">%p</span><span class="nc">.signin-terms</span>
</span><span class='line'>    <span class="nt">%b</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;we_will_never_post&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="nt">%br</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;pages.home.signin_terms&#39;</span><span class="p">,</span> <span class="ss">appname</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">terms_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;terms&#39;</span><span class="p">),</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}),</span> <span class="n">policy_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;policy&#39;</span><span class="p">),</span> <span class="ss">:policy</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">html_safe</span>
</span></code></pre></td></tr></table></div></figure>


<p>Necassary routes to manage sessions</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Sessions</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#new&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:auth_at_provider</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider/callback&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#create&#39;</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/failure&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;signout&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the user model. Removed the nonrelevant fields. As you can see I’m collecting enough data to make decisions.</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="no">Concerns</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Authentication</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="no">Concerns</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:provider</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:uid</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_token</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_expires_at</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_permissions</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_friends</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_favorites</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">DateTime</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">&#39;2014-01-01&#39;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:gender</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:bio</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:languages</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:birthday</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:work</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:education</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_verified</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the module for facebook authentication. This will collect facebook user data before saving the user.</p>

<figure class='code'><figcaption><span>app/models/concerns/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>      <span class="k">module</span> <span class="nn">Authentication</span>
</span><span class='line'>        <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_fields_from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>            <span class="n">set_credentials</span> <span class="n">auth</span><span class="o">.</span><span class="n">credentials</span>
</span><span class='line'>            <span class="n">set_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">info</span>
</span><span class='line'>            <span class="n">set_extra_raw_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>            <span class="n">set_extra_raw_info_special_permissions</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>            <span class="n">set_permissions</span>
</span><span class='line'>            <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FacebookDataCacher</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'>          <span class="k">rescue</span> <span class="no">Redis</span><span class="o">::</span><span class="no">CannotConnectError</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="kp">private</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">oauth_expires_at</span> <span class="o">=</span>  <span class="no">Time</span><span class="o">.</span><span class="n">at</span> <span class="n">credentials</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">||</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">facebook_verified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">verified</span> <span class="o">||</span> <span class="kp">false</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_extra_raw_info</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">bio</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">languages</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_extra_raw_info_special_permissions</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">birthday</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span><span class="p">,</span> <span class="s2">&quot;%m/%d/%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">at_midnight</span> <span class="k">if</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">work</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">education</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">education</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_permissions</span>
</span><span class='line'>            <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_permissions</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;permissions&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>            <span class="n">user</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module is for caching data. I’m making resque collect more and more details. We will run resque workers to get them. You can also schedule the process with resque scheduler. Checkout facebook graph api for more data to get. And checkout resque gem for details.</p>

<figure class='code'><figcaption><span>app/models/concerns/facebook.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Facebook</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>          <span class="vi">@facebook</span> <span class="o">||=</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">block_given?</span> <span class="p">?</span> <span class="k">yield</span><span class="p">(</span><span class="vi">@facebook</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@facebook</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">APIError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">has_facebook_permission?</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>           <span class="n">facebook_permissions</span><span class="o">[</span><span class="n">scope</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">facebook_permissions?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">cache_facebook_data?</span>
</span><span class='line'>          <span class="n">favorites</span> <span class="o">=</span> <span class="sx">%w(music books movies television games activities interests)</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch_api</span><span class="o">|</span>
</span><span class='line'>              <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;friends&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="n">favorites</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">favorite</span><span class="o">|</span>
</span><span class='line'>                <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">favorite</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>               <span class="nb">self</span><span class="o">.</span><span class="n">facebook_friends</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_favorites</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">flatten</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="k">return</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a resque worker to cache facebook data.</p>

<figure class='code'><figcaption><span>app/workers/facebook_data_cacher.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FacebookDataCacher</span>
</span><span class='line'>  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:facebook_cache_data_queue</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="n">user_id</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">facebook_data_cached_at</span> <span class="o">&lt;</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">cache_expiry_time</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">cache_facebook_data?</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we go. The code above will get us the data we defined on our model and it will be updating and adding more data when user logins. Now it’s time to make decisions!!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/09/full-login-system-out-of-omniauth-identity-with-mongoid-and-jquery-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-09T11:31:32+02:00" pubdate data-updated="true">Feb 9<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I want to start this post with one definite sentence. Don’t use omniauth-identity! Why? Because it doesn’t cover the “details” of a login system. And for a login system details are absolutely necesssary. It does make the user register and sign-in but thats all. No forms, no password resets, no emails, no decent validations, etc. It’s really simple and that simplicity won’t help you. And the worst thing is it’s hard to customise. You have that initialiser file and you don’t understand what you do in there. There are also no resources other than Ryan’s Railscast and couple of blog posts. The reason I’m writing this blog post is because there may be people still wan’t to use it as I do. I’ve lost considerable amount of time dealing with it’s login fail bug, integrating it and making a decent login system out of it and now after all that time I don’t want to deal with login systems at all.</p>

<p>So we start with adding the gem</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;omniauth-identity&#39;</span>
</span><span class='line'>  <span class="no">And</span> <span class="n">we</span> <span class="n">have</span> <span class="n">this</span> <span class="n">initialiser</span> <span class="n">file</span> <span class="n">also</span> <span class="n">used</span> <span class="k">in</span> <span class="n">other</span> <span class="n">omniauth</span> <span class="n">providers</span><span class="o">.</span> <span class="no">That</span> <span class="n">line</span> <span class="n">fixes</span> <span class="n">the</span> <span class="n">bug</span><span class="o">.</span><span class="n">.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">on_failure</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
</span><span class='line'>    <span class="no">OmniAuth</span><span class="o">::</span><span class="no">FailureEndpoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">redirect_to_failure</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we create the modal and yes it doesn’t directly integrate with your user model(or I didn’t lost time trying to do it). You will have a seperate mongoid collection and it will store identities</p>

<figure class='code'><figcaption><span>models/identity.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Identity</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Identity</span><span class="o">::</span><span class="no">Models</span><span class="o">::</span><span class="no">Mongoid</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">validate</span> <span class="ss">:uniqueness_of_email</span>
</span><span class='line'>  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="sr">/^[-a-z0-9_+\.]+\@([-a-z0-9]+\.)+[a-z0-9]{2,4}$/i</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">uniqueness_of_email</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="s2">&quot;email is already in use&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have authentication file in models directory that also manages omniauth facebook so after saving the identity don’t forget to save the user too. I’m setting user’s provider as “identity”, since I only get name and email I had to set uid as username.</p>

<figure class='code'><figcaption><span>models/concerns/user/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">new_record?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">has_access?</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span><span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Controller only has new method. Taken from Ryan’s railcast.</p>

<figure class='code'><figcaption><span>controllers/identities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">IdentitiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="vi">@identity</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.identity&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>sessions controller as usual</p>

<figure class='code'><figcaption><span>controllers/sessions_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">skip_before_filter</span> <span class="ss">:require_login</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="o">[</span><span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">from_omniauth</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:redirect_to</span><span class="p">)</span> <span class="o">||</span> <span class="n">new_quote_path</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">failure</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use modals to show forms</p>

<figure class='code'><figcaption><span>views/pages/home.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;register_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#new-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span> veya
</span><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.login-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#login-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/shared/_modal_login_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#login-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;identities/login&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/shared/_modal_new_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#new-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;new_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.new_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span><span class="n">render</span> <span class="s1">&#39;identities/register&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/identities/_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">=</span><span class="n">form_tag</span><span class="p">(</span><span class="s1">&#39;/auth/identity/callback&#39;</span><span class="p">,</span>  <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;actual-login-form&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:login_error</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;error_code_label_login&#39;</span>
</span><span class='line'>    <span class="o">.</span><span class="n">field</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:auth_key</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:auth_key</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="o">.</span><span class="n">field</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="o">.</span><span class="n">actions</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login&#39;</span><span class="p">),</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login_submit&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">%</span><span class="n">br</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.forgot_password&#39;</span><span class="p">),</span> <span class="n">new_password_reset_path</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">==</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="ss">:coffee</span>
</span><span class='line'>      <span class="err">$</span><span class="p">(</span><span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#login-identity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">modal</span> <span class="s2">&quot;show&quot;</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#error_code_label_login&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#password&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/identities/_register.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">form_tag</span> <span class="s2">&quot;/auth/identity/register&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;signupForm&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="vi">@identity</span> <span class="o">&amp;&amp;</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>      <span class="o">%</span><span class="n">h2</span>
</span><span class='line'>        <span class="o">=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prohibited</span> <span class="n">this</span> <span class="n">account</span> <span class="n">from</span> <span class="n">being</span> <span class="ss">saved</span><span class="p">:</span>
</span><span class='line'>      <span class="o">%</span><span class="n">ul</span>
</span><span class='line'>        <span class="o">-</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>          <span class="o">%</span><span class="n">li</span><span class="o">=</span> <span class="n">msg</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.name&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password_confirmation</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password_again&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.register&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use jquery validation which I love</p>

<figure class='code'><figcaption><span>pages.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;ready&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">signupForm&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>      <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>      <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>      <span class="nv">rules:</span>
</span><span class='line'>        <span class="nv">name: </span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">remote: </span><span class="s">&quot;/users/check_email&quot;</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>        <span class="nv">password_confirmation:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>          <span class="nv">equalTo: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">password&quot;</span>
</span><span class='line'>      <span class="nv">messages:</span>
</span><span class='line'>        <span class="nv">name: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name.required&quot;</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password.minlength&quot;</span>
</span><span class='line'>        <span class="nv">password_confirmation:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.required&quot;</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.minlength&quot;</span>
</span><span class='line'>          <span class="nv">equalTo: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.equalTo&quot;</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>          <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span><span class='line'>          <span class="nv">remote: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.remote&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">actual-login-form&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>      <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>      <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>      <span class="nv">rules:</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">messages:</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>          <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>controllers/users_controller/check_email.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">check_email</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>     <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>My password reset codes</p>

<figure class='code'><figcaption><span>controllers/password_resets_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">send_password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.email_sent&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">new_password_reset_path</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.expired&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">permitted_params</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@identity</span> <span class="o">=</span> <span class="no">Identity</span><span class="o">.</span><span class="n">find_by</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>        <span class="vi">@identity</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
</span><span class='line'>        <span class="vi">@identity</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.password_has_been_reset&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.error_in_password_reset&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/password_resets/new.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span> <span class="n">form_tag</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span> <span class="k">do</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.reset_password&#39;</span><span class="p">),</span>  <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/password_resets/edit.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span> <span class="n">form_for</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="p">-</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="nc">.error_messages</span>
</span><span class='line'>      <span class="nt">%h2</span> Form is invalid
</span><span class='line'>      <span class="nt">%ul</span>
</span><span class='line'>        <span class="p">-</span> <span class="k">for</span> <span class="n">message</span> <span class="k">in</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
</span><span class='line'>          <span class="nt">%li</span><span class="p">=</span> <span class="n">message</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="nc">.actions</span><span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Update Password&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mailers</p>

<figure class='code'><figcaption><span>app/mailers/password_resets_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">password_reset_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>    <span class="n">mail</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.pass_reset.subject&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the actual mail which I’ve only paste the relevant part</p>

<figure class='code'><figcaption><span>app/views/mailers/password_reset.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>     <span class="nf">#href:</span> &quot;<span class="si">#{</span><span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_token</span><span class="p">)</span><span class="si">}</span>&quot;}=t(&quot;.pass_reset_link_button&quot;)
</span></code></pre></td></tr></table></div></figure>


<p>So it works. At least omniauth-identity has tests..I really could not do test-driven with it so I’ll add the tests soon..</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Creating Activity Cal-heatmap Using Public_activity and Mongoid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-02T12:11:21+03:00" pubdate data-updated="true">Aug 2<sup>nd</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://dl.dropbox.com/u/47336405/Selection_043.png"></p>

<p>I had to present activites of a service provider to it’s users in a unique way. First thought of creating an activity stream but knew that the users won’t be reading them since the activity would be about the services of the provider- not something “social”. Then thought of creating a line graph that shows the days and works done by the provider. It wouldn’t be unique though. I thought and thought by looking at my github dashboard and idea came up. I always liked Github’s collaboration heatmap. It was unique and concise. So I decided to create my own activity heatmap.
I needed to sort out three things in order to make it happen.
Finding out a github-like heatmap to present activities Logging provider activites in a way that I can present on map Making mongoid and Rails 4 work with heatmap and activity logs.
Here is how I created my activity heatmap:
Kamisama has done great job on creating cal-heatmaps. Its obvious that github uses his work too. You can find his work on <a href="https://github.com/kamisama/cal-heatmap.">https://github.com/kamisama/cal-heatmap.</a> You have to download cal-heatmap.js, d3.js and for localisation; moment.js does great job. I had to present three activites to user;
When provider gets selected by user. When provider returns to quote When provider does the work
You cannot divide the activities to parts in cal-heatmap. You provide timestamps with numeric values and cal-heatmap shows the data. So I first had to fetch these three activities, count them and show them on map. Then I would present the details once the user clicks on a cell. So “get_provider_counts” counts the data in a way cal-heatmap understands, “get_activity gets” the data once I click on a cell.</p>

<figure class='code'><figcaption><span>providers.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nv">initProviderShow = </span><span class="nf">-&gt;</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span>
</span><span class='line'>      <span class="nv">url: </span><span class="s">&quot;/activities/get_provider_counts&quot;</span>
</span><span class='line'>      <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>      <span class="nv">data:</span>
</span><span class='line'>        <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>      <span class="nv">dataType: </span><span class="s">&quot;json&quot;</span>
</span><span class='line'>      <span class="p">).</span><span class="nx">success</span> <span class="nf">(data) -&gt;</span>
</span><span class='line'>      <span class="nx">moment</span><span class="p">.</span><span class="nx">lang</span> <span class="s">&quot;en&quot;</span>
</span><span class='line'>      <span class="nv">calendar = </span><span class="k">new</span> <span class="nx">CalHeatMap</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">calendar</span><span class="p">.</span><span class="nx">init</span>
</span><span class='line'>        <span class="nv">itemSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat&quot;</span>
</span><span class='line'>        <span class="nv">data: </span><span class="nx">data</span>
</span><span class='line'>        <span class="nv">start: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">domain: </span><span class="s">&quot;month&quot;</span>
</span><span class='line'>        <span class="nv">subDomain: </span><span class="s">&quot;day&quot;</span>
</span><span class='line'>        <span class="nv">range: </span><span class="mi">7</span>
</span><span class='line'>        <span class="nv">cellSize: </span><span class="mi">15</span>
</span><span class='line'>        <span class="nv">cellPadding: </span><span class="mi">5</span>
</span><span class='line'>        <span class="nv">domainGutter: </span><span class="mi">20</span>
</span><span class='line'>        <span class="nv">displayScale: </span><span class="kc">false</span>
</span><span class='line'>        <span class="nv">previousSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-PreviousDomain-selector&quot;</span>
</span><span class='line'>        <span class="nv">nextSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-NextDomain-selector&quot;</span>
</span><span class='line'>        <span class="nv">domainLabelFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>          <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s">&quot;MMMM&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">subDomainDateFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>          <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span> <span class="s">&quot;LL&quot;</span>
</span><span class='line'>        <span class="nv">subDomainTitleFormat:</span>
</span><span class='line'>          <span class="nv">empty: </span><span class="s">&quot;{date} +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">no_activites</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">          filled: &quot;</span><span class="p">{</span><span class="nx">date</span><span class="p">}</span>  <span class="p">{</span><span class="nx">count</span><span class="p">}</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.has_activites&quot;</span>
</span><span class='line'>        <span class="nv">onClick: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
</span><span class='line'>            <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>            <span class="nv">url: </span><span class="s">&quot;/activities/get_activity&quot;</span>
</span><span class='line'>            <span class="nv">data: </span><span class="p">{</span> <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nv">selected: </span><span class="nx">date</span><span class="p">}</span>
</span><span class='line'>            <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>              <span class="nv">text1= </span><span class="s">&quot;&quot;</span>
</span><span class='line'>              <span class="nx">text2</span> <span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>              <span class="nv">text3 = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>              <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>                <span class="nv">text1 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.selected</span>
</span><span class='line'><span class="s">              if data.returned &gt; 0</span>
</span><span class='line'><span class="s">                text2 = data.returned + &quot;</span> <span class="s">&quot; +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">returned</span>
</span><span class='line'>              <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>                <span class="nv">text3 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.done&quot;</span>
</span><span class='line'>              <span class="k">if</span> <span class="nx">text1</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text2</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text3</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="nx">text1</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text2</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text3</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>            <span class="nv">error: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>                <span class="k">return</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>        <span class="nv">legend: </span><span class="p">[</span>
</span><span class='line'>          <span class="mi">1</span>
</span><span class='line'>          <span class="mi">3</span>
</span><span class='line'>          <span class="mi">5</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>        <span class="nv">legendColors: </span><span class="p">[</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="err">#</span><span class="s">ecf5e2&quot;</span>
</span><span class='line'>          <span class="s">&quot;</span><span class="err">#</span><span class="s">232181&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was about to store provider activities myself but then found a great gem to sort it out. Its public_activity gem. <a href="https://github.com/pokonski/public_activity">https://github.com/pokonski/public_activity</a> It’s quote comprehensve and does support mongoid and Rails 4.
The system I’m working on is about User creating quotes to providers. For every quote user selects up to three providers. Provider “returns” back to quote and if agrees with user, provider “does” the work. So I’m tracking the user, relation to providers collection, returned providers and providerdone.</p>

<figure class='code'><figcaption><span>Quote.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">require</span> <span class="s1">&#39;autoinc&#39;</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Quote</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Timestamps</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Paranoia</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Slug</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Autoinc</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Geocoder</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Mongoid</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Concerns</span><span class="o">::</span><span class="no">GmapRoute</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">PublicActivity</span><span class="o">::</span><span class="no">Model</span>
</span><span class='line'>    <span class="n">tracked</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="ss">:user</span>
</span><span class='line'>    <span class="n">tracked</span> <span class="ss">:params</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">:returned_providers</span> <span class="o">=&gt;</span> <span class="ss">:returned_providers</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:providerdone</span> <span class="o">=&gt;</span> <span class="ss">:providerdone</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:providers</span> <span class="o">=&gt;</span> <span class="ss">:provider_ids</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I created a controller to store activities. Our system does not have activity streams so this will be useful for new features too. These two methods are for ajax requests I explained above.</p>

<figure class='code'><figcaption><span>activities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">def</span> <span class="nf">get_provider_counts</span>
</span><span class='line'>      <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@activities</span> <span class="o">=</span> <span class="no">PublicActivity</span><span class="o">::</span><span class="no">Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>      <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>      <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>      <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>      <span class="vi">@caldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">seldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">retdata</span> <span class="o">=</span><span class="p">{}</span>
</span><span class='line'>      <span class="n">donedata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">selected_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>        <span class="n">seldata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">returned_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>        <span class="n">retdata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">done_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>        <span class="n">donedata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="vi">@caldata</span> <span class="o">=</span> <span class="n">donedata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">retdata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>      <span class="vi">@caldata</span> <span class="o">=</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seldata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">to_json</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_activity</span>
</span><span class='line'>      <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:selected</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@activities</span> <span class="o">=</span> <span class="no">PublicActivity</span><span class="o">::</span><span class="no">Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>      <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:selected</span><span class="o">=&gt;</span> <span class="n">selected_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:returned</span> <span class="o">=&gt;</span><span class="n">returned_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:done</span><span class="o">=&gt;</span><span class="n">done_providers</span><span class="o">.</span><span class="n">count</span><span class="p">}}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally the view to show cal-heatmap</p>

<figure class='code'><figcaption><span>providers/show.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nt">%div</span>
</span><span class='line'>  <span class="nf">#calheat</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;position:relative;&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%p</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-PreviousDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-left</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-NextDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-right</span>
</span><span class='line'>  <span class="nt">%h5</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span><span class="s2">&quot;text-align: center;margin-top: -10px;&quot;</span><span class="p">}</span>
</span><span class='line'>        <span class="nf">#onClick-placeholder</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/03/two-factor-authentication-using-active-model-otp-with-mongoid/">Two Factor Authentication Using Active_model_otp With Mongoid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-06-03T17:13:26+03:00" pubdate data-updated="true">Jun 3<sup>rd</sup>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had to implement two factor authentication using a custom sms provider. Active model OTP really helped me in generating one time use tokens. I thought it won’t be working with mongoid but it was easy to integrate it. Another issue was to make user authenticated on the same page. We just didn’t want to direct user to another page for phone verification. So I’ve written some js to sort it out. It’s a bit “manual” because clientsidevalidations caused problems in Rails4. Everything gets validated both on client and server side. Here you can see relevant parts from the code.</p>

<figure class='code'><figcaption><span>provider.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">def</span> <span class="nf">check_verification_code</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:result</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">}</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">authenticate_otp</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:verification_code</span><span class="o">]</span><span class="p">,</span> <span class="ss">drift</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span> <span class="c1">#drift enough for old users </span>
</span><span class='line'>      <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:result</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:mobile_verified</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">sendverification</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:result</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">}</span>
</span><span class='line'>    <span class="n">phone</span> <span class="o">=</span> <span class="n">validate_phone</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:verification_phone</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">phone</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>      <span class="n">sms</span> <span class="o">=</span> <span class="no">Sms</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">sms</span><span class="o">.</span><span class="n">send_sms</span><span class="p">(</span><span class="o">[</span><span class="n">phone</span><span class="o">]</span><span class="p">,</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">sms_from</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;verification_message&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">current_user</span><span class="o">.</span><span class="n">otp_code</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:result</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>new.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>
</span><span class='line'>  <span class="p">=</span> <span class="n">bootstrap_form_for</span> <span class="vi">@provider</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="vi">@provider</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="ss">validate</span><span class="p">:</span> <span class="kp">true</span>  <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>      <span class="nc">.span</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s1">&#39;text-align: center&#39;</span><span class="p">}</span>
</span><span class='line'>        <span class="nt">%h4</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.provider_exp&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="nt">%h5</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.provider_exp1&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="nf">#phone_details</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:mobile_phone</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;verify_phone_label&#39;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">default_tag</span> <span class="ss">:text_field</span><span class="p">,</span> <span class="ss">:verification_phone</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">&#39;05XX XXXXXXX&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;verification_phone&#39;</span> <span class="p">,</span><span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;{mask:&#39;(0569) 9999999&#39;}&quot;</span><span class="p">,</span> <span class="ss">:alt</span><span class="o">=&gt;</span> <span class="s2">&quot;(0569) 9999999&#39;&quot;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">button_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.send_code&#39;</span><span class="p">),</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="o">=&gt;</span> <span class="s1">&#39;sendverification&#39;</span><span class="p">,</span> <span class="ss">:class</span><span class="o">=&gt;</span> <span class="s1">&#39;btn btn-medium btn-success&#39;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:error_mobile_label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;error_mobile_label&#39;</span>
</span><span class='line'>        <span class="nt">%hr</span>
</span><span class='line'>        <span class="nf">#verification_details</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:info_label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;verify_code_label&#39;</span> <span class="p">,</span> <span class="ss">style</span><span class="p">:</span><span class="s2">&quot;display:none&quot;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">default_tag</span> <span class="ss">:text_field</span><span class="p">,</span> <span class="ss">:verification_code</span><span class="p">,</span> <span class="ss">placeholder</span><span class="p">:</span> <span class="s1">&#39;XXXXXX&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;verification_code&#39;</span> <span class="p">,</span><span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;{mask:&#39;999999&#39;}&quot;</span><span class="p">,</span> <span class="ss">:alt</span><span class="o">=&gt;</span> <span class="s2">&quot;999999&#39;&quot;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:error_label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;error_code_label&#39;</span>
</span><span class='line'>          <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:success_label</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;success_code_label&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>providers.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">bind</span> <span class="s">&quot;keyup&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">6</span> <span class="c1">#second clientside validation</span>
</span><span class='line'>        <span class="nv">data = </span><span class="kc">undefined</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
</span><span class='line'>          <span class="nv">type: </span><span class="s">&quot;POST&quot;</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/check_verification_code&quot;</span>
</span><span class='line'>          <span class="nv">data: </span><span class="s">&quot;verification_code=&quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span> <span class="o">is</span> <span class="kc">true</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_business_phone&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_phone&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">())</span>
</span><span class='line'>              <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">)</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_code_label&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">success_code_label&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_submit&quot;</span><span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;value&quot;</span><span class="p">,</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.pleasewait&quot;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">providerform&quot;</span><span class="p">).</span><span class="nx">submit</span><span class="p">()</span> <span class="c1"># provider gets mobile_verified inside</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_code_label&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="s">&#39;shared.navbar.error_in_code&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>          <span class="nv">error: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_code_label&quot;</span><span class="p">).</span><span class="nx">text</span>  <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="s">&#39;shared.navbar.problem_sending_request&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_code_label&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">success_code_label&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">interval = </span><span class="kc">undefined</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">sendverification&quot;</span><span class="p">).</span><span class="nx">click</span> <span class="nf">-&gt;</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_phone&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">14</span> <span class="c1">#second clientside vald(before svrside)</span>
</span><span class='line'>        <span class="nv">time = </span><span class="mi">30000</span> <span class="c1">#OTP default wait time</span>
</span><span class='line'>        <span class="nv">seconds = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">time</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">each</span> <span class="nf">-&gt;</span>
</span><span class='line'>          <span class="nv">disabled_elem = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_phone&quot;</span><span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>          <span class="nx">disabled_elem</span><span class="p">.</span><span class="nx">prop</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>          <span class="nv">new_text = </span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="s">&#39;shared.navbar.send_code_again&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">disabled_elem</span><span class="p">.</span><span class="nx">val</span> <span class="nx">new_text</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="nx">seconds</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
</span><span class='line'>          <span class="nv">interval = </span><span class="nx">setInterval</span><span class="p">(</span><span class="nf">-&gt;</span>
</span><span class='line'>            <span class="nx">disabled_elem</span><span class="p">.</span><span class="nx">val</span> <span class="nx">new_text</span> <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="o">--</span><span class="nx">seconds</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">seconds</span> <span class="o">is</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_phone&quot;</span><span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span>
</span><span class='line'>              <span class="nx">disabled_elem</span><span class="p">.</span><span class="nx">prop</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span>
</span><span class='line'>              <span class="nx">disabled_elem</span><span class="p">.</span><span class="nx">val</span> <span class="nx">new_text</span>
</span><span class='line'>              <span class="nx">clearInterval</span> <span class="nx">interval</span>
</span><span class='line'>            <span class="k">return</span>
</span><span class='line'>          <span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
</span><span class='line'>          <span class="nv">data: </span><span class="s">&quot;verification_phone=&quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_phone&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">type: </span><span class="s">&quot;get&quot;</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/sendverification&quot;</span>
</span><span class='line'>          <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">result</span> <span class="o">is</span> <span class="kc">true</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verify_code_label&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_mobile_label&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_code_label&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">val</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">verification_code&quot;</span><span class="p">).</span><span class="nx">focus</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_mobile_label&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="s">&#39;shared.navbar.problem_sending_sms&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>          <span class="nv">error: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">error_mobile_label&quot;</span><span class="p">).</span><span class="nx">text</span>  <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span><span class="p">(</span><span class="s">&#39;shared.navbar.problem_sending_request&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>providers_controller.rb </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="ss">:mobile_verified</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@provider</span><span class="o">.</span><span class="n">mobile_verified</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="vi">@provider</span><span class="o">.</span><span class="n">business_phone</span> <span class="o">=</span> <span class="n">validate_phone</span><span class="p">(</span> <span class="n">params</span><span class="o">[</span><span class="ss">:provider</span><span class="o">][</span><span class="ss">:business_phone</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:mobile_verified</span><span class="o">]</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>user.rb </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s2">&quot;active_model_otp&quot;</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">OneTimePassword</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="n">has_one_time_password</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="n">field</span> <span class="ss">:email</span>
</span><span class='line'>    <span class="n">field</span> <span class="ss">:otp_secret_key</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/18/fancy-return-to-old-school-trees/">Fancy Return to Old School Trees</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/09/full-login-system-out-of-omniauth-identity-with-mongoid-and-jquery-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Creating Activity Cal-heatmap Using Public_activity and Mongoid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/03/two-factor-authentication-using-active-model-otp-with-mongoid/">Two Factor Authentication Using Active_model_otp With Mongoid</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Caner Cakmak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
