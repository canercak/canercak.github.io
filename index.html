
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="dsadasdsadsa
">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://canercak.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:canercak.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/18/fancy-return-to-old-school-trees/">Fancy Return to Old School Trees</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-18T23:36:40+03:00" pubdate data-updated="true">Jul 18<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>dsadasdsadsa</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-20T21:06:29+02:00" pubdate data-updated="true">Mar 20<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Data is the key to long-lasting relationship with users. The more, the better. Once we have relevant data; we can target marketing, develop features tailored to specific users and make users trust each other. So how do we collect relevant data? There is an easy way. It’s Facebook.</p>

<p>First, talk with your solicitor to add your Terms&amp;Conditions document that you are collecting data by using facebook. Then make a big “Login with Facebook” button on your landing page. Don’t forget to write that the user accepts the conditions once the button clicked. Something like this:</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_044.png"></p>

<p> Then you are ready to go. I use three gems to collect data: omniauth, omniauth-facebook and koala. For config settings there is simple config and for caching data I use resque. I know that using devise could be easier. But simply, its big.(I have omniauth-identity for nonfacebook logins) So this will be different than devise’s way.</p>

<p>Here we define our facebook app details. Sensitive data is stored on local.rb file and Simpleconfig serves them to environments. Checkout simpleconfig for details.</p>

<figure class='code'><figcaption><span>config/settings/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleConfig</span><span class="o">.</span><span class="n">for</span> <span class="ss">:application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">group</span> <span class="ss">:facebook</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:namespace</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_NAMESPACE&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_id</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_APP_ID&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_secret</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_SECRET&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:scope</span><span class="p">,</span> <span class="s1">&#39;email, publish_stream, user_birthday, user_about_me, user_education_history, user_interests, user_likes, user_religion_politics, user_work_history&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:cache_expiry_time</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="n">days</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are omniauth initialization details. You can learn more about omniauth on it’s github page.</p>

<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'>  <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Builder</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>      <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The haml view for our big facebook button.</p>

<figure class='code'><figcaption><span>views/pages/_facebook_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>
</span><span class='line'>  <span class="nc">.hidden-phone</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">auth_at_provider_path</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="ss">:facebook</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-large btn-facebook&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>      <span class="nt">%i</span><span class="nc">.icon-facebook-sign.icon-large</span>
</span><span class='line'>      <span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_with_facebook&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nt">%p</span><span class="nc">.signin-terms</span>
</span><span class='line'>    <span class="nt">%b</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;we_will_never_post&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="nt">%br</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;pages.home.signin_terms&#39;</span><span class="p">,</span> <span class="ss">appname</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">terms_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;terms&#39;</span><span class="p">),</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}),</span> <span class="n">policy_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;policy&#39;</span><span class="p">),</span> <span class="ss">:policy</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">html_safe</span>
</span></code></pre></td></tr></table></div></figure>


<p>Necassary routes to manage sessions</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Sessions</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#new&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:auth_at_provider</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider/callback&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#create&#39;</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/failure&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;signout&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the user model. Removed the nonrelevant fields. As you can see I’m collecting enough data to make decisions.</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="no">Concerns</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Authentication</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="no">Concerns</span><span class="o">::</span><span class="no">User</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:provider</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:uid</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_token</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_expires_at</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_permissions</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_friends</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_favorites</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">DateTime</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">&#39;2014-01-01&#39;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:gender</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:bio</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:languages</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:birthday</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:work</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:education</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_verified</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the module for facebook authentication. This will collect facebook user data before saving the user.</p>

<figure class='code'><figcaption><span>app/models/concerns/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>      <span class="k">module</span> <span class="nn">Authentication</span>
</span><span class='line'>        <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_fields_from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>            <span class="n">set_credentials</span> <span class="n">auth</span><span class="o">.</span><span class="n">credentials</span>
</span><span class='line'>            <span class="n">set_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">info</span>
</span><span class='line'>            <span class="n">set_extra_raw_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>            <span class="n">set_extra_raw_info_special_permissions</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>            <span class="n">set_permissions</span>
</span><span class='line'>            <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FacebookDataCacher</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'>          <span class="k">rescue</span> <span class="no">Redis</span><span class="o">::</span><span class="no">CannotConnectError</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="kp">private</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">oauth_expires_at</span> <span class="o">=</span>  <span class="no">Time</span><span class="o">.</span><span class="n">at</span> <span class="n">credentials</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">||</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">facebook_verified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">verified</span> <span class="o">||</span> <span class="kp">false</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_extra_raw_info</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">bio</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">languages</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_extra_raw_info_special_permissions</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">birthday</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span><span class="p">,</span> <span class="s2">&quot;%m/%d/%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">at_midnight</span> <span class="k">if</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">work</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">education</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">education</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">set_permissions</span>
</span><span class='line'>            <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_permissions</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;permissions&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>          <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>            <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>            <span class="n">user</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module is for caching data. I’m making resque collect more and more details. We will run resque workers to get them. You can also schedule the process with resque scheduler. Checkout facebook graph api for more data to get. And checkout resque gem for details.</p>

<figure class='code'><figcaption><span>app/models/concerns/facebook.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Facebook</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>          <span class="vi">@facebook</span> <span class="o">||=</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">block_given?</span> <span class="p">?</span> <span class="k">yield</span><span class="p">(</span><span class="vi">@facebook</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@facebook</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="no">Koala</span><span class="o">::</span><span class="no">Facebook</span><span class="o">::</span><span class="no">APIError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">has_facebook_permission?</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>           <span class="n">facebook_permissions</span><span class="o">[</span><span class="n">scope</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">facebook_permissions?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">cache_facebook_data?</span>
</span><span class='line'>          <span class="n">favorites</span> <span class="o">=</span> <span class="sx">%w(music books movies television games activities interests)</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch_api</span><span class="o">|</span>
</span><span class='line'>              <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;friends&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="n">favorites</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">favorite</span><span class="o">|</span>
</span><span class='line'>                <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">favorite</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>               <span class="nb">self</span><span class="o">.</span><span class="n">facebook_friends</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_favorites</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">flatten</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="k">return</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a resque worker to cache facebook data.</p>

<figure class='code'><figcaption><span>app/workers/facebook_data_cacher.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FacebookDataCacher</span>
</span><span class='line'>  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:facebook_cache_data_queue</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="n">user_id</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">facebook_data_cached_at</span> <span class="o">&lt;</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">cache_expiry_time</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">cache_facebook_data?</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we go. The code above will get us the data we defined on our model and it will be updating and adding more data when user logins. Now it’s time to make decisions!!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/09/full-login-system-out-of-omniauth-identity-with-mongoid-and-jquery-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-09T11:31:32+02:00" pubdate data-updated="true">Feb 9<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I want to start this post with one definite sentence. Don’t use omniauth-identity! Why? Because it doesn’t cover the “details” of a login system. And for a login system details are absolutely necesssary. It does make the user register and sign-in but thats all. No forms, no password resets, no emails, no decent validations, etc. It’s really simple and that simplicity won’t help you. And the worst thing is it’s hard to customise. You have that initialiser file and you don’t understand what you do in there. There are also no resources other than Ryan’s Railscast and couple of blog posts. The reason I’m writing this blog post is because there may be people still wan’t to use it as I do. I’ve lost considerable amount of time dealing with it’s login fail bug, integrating it and making a decent login system out of it and now after all that time I don’t want to deal with login systems at all.</p>

<p>So we start with adding the gem</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;omniauth-identity&#39;</span>
</span><span class='line'>  <span class="no">And</span> <span class="n">we</span> <span class="n">have</span> <span class="n">this</span> <span class="n">initialiser</span> <span class="n">file</span> <span class="n">also</span> <span class="n">used</span> <span class="k">in</span> <span class="n">other</span> <span class="n">omniauth</span> <span class="n">providers</span><span class="o">.</span> <span class="no">That</span> <span class="n">line</span> <span class="n">fixes</span> <span class="n">the</span> <span class="n">bug</span><span class="o">.</span><span class="n">.</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">on_failure</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
</span><span class='line'>    <span class="no">OmniAuth</span><span class="o">::</span><span class="no">FailureEndpoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">redirect_to_failure</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we create the modal and yes it doesn’t directly integrate with your user model(or I didn’t lost time trying to do it). You will have a seperate mongoid collection and it will store identities</p>

<figure class='code'><figcaption><span>models/identity.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Identity</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Identity</span><span class="o">::</span><span class="no">Models</span><span class="o">::</span><span class="no">Mongoid</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">validate</span> <span class="ss">:uniqueness_of_email</span>
</span><span class='line'>  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="sr">/^[-a-z0-9_+\.]+\@([-a-z0-9]+\.)+[a-z0-9]{2,4}$/i</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">uniqueness_of_email</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="s2">&quot;email is already in use&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have authentication file in models directory that also manages omniauth facebook so after saving the identity don’t forget to save the user too. I’m setting user’s provider as “identity”, since I only get name and email I had to set uid as username.</p>

<figure class='code'><figcaption><span>models/concerns/user/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">new_record?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">has_access?</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span><span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>      <span class="no">UserMailer</span><span class="o">.</span><span class="n">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Controller only has new method. Taken from Ryan’s railcast.</p>

<figure class='code'><figcaption><span>controllers/identities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">IdentitiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="vi">@identity</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.identity&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>sessions controller as usual</p>

<figure class='code'><figcaption><span>controllers/sessions_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">skip_before_filter</span> <span class="ss">:require_login</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="o">[</span><span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">from_omniauth</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:redirect_to</span><span class="p">)</span> <span class="o">||</span> <span class="n">new_quote_path</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">failure</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use modals to show forms</p>

<figure class='code'><figcaption><span>views/pages/home.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;register_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#new-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span> veya
</span><span class='line'>  <span class="nt">%big</span><span class="nc">.inline-block.login-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#login-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/shared/_modal_login_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#login-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;identities/login&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/shared/_modal_new_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#new-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;new_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.new_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span><span class="n">render</span> <span class="s1">&#39;identities/register&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/identities/_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">=</span><span class="n">form_tag</span><span class="p">(</span><span class="s1">&#39;/auth/identity/callback&#39;</span><span class="p">,</span>  <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;actual-login-form&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:login_error</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;error_code_label_login&#39;</span>
</span><span class='line'>    <span class="o">.</span><span class="n">field</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:auth_key</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:auth_key</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="o">.</span><span class="n">field</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="o">.</span><span class="n">actions</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login&#39;</span><span class="p">),</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login_submit&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">%</span><span class="n">br</span>
</span><span class='line'>      <span class="o">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.forgot_password&#39;</span><span class="p">),</span> <span class="n">new_password_reset_path</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">==</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="ss">:coffee</span>
</span><span class='line'>      <span class="err">$</span><span class="p">(</span><span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#login-identity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">modal</span> <span class="s2">&quot;show&quot;</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#error_code_label_login&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>        <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#password&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/identities/_register.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">form_tag</span> <span class="s2">&quot;/auth/identity/register&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;signupForm&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="vi">@identity</span> <span class="o">&amp;&amp;</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>      <span class="o">%</span><span class="n">h2</span>
</span><span class='line'>        <span class="o">=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prohibited</span> <span class="n">this</span> <span class="n">account</span> <span class="n">from</span> <span class="n">being</span> <span class="ss">saved</span><span class="p">:</span>
</span><span class='line'>      <span class="o">%</span><span class="n">ul</span>
</span><span class='line'>        <span class="o">-</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>          <span class="o">%</span><span class="n">li</span><span class="o">=</span> <span class="n">msg</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.name&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password_confirmation</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password_again&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.register&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use jquery validation which I love</p>

<figure class='code'><figcaption><span>pages.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;ready&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">signupForm&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>      <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>      <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>      <span class="nv">rules:</span>
</span><span class='line'>        <span class="nv">name: </span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">remote: </span><span class="s">&quot;/users/check_email&quot;</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>        <span class="nv">password_confirmation:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>          <span class="nv">equalTo: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">password&quot;</span>
</span><span class='line'>      <span class="nv">messages:</span>
</span><span class='line'>        <span class="nv">name: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name.required&quot;</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password.minlength&quot;</span>
</span><span class='line'>        <span class="nv">password_confirmation:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.required&quot;</span>
</span><span class='line'>          <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.minlength&quot;</span>
</span><span class='line'>          <span class="nv">equalTo: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.equalTo&quot;</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>          <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span><span class='line'>          <span class="nv">remote: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.remote&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">actual-login-form&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>      <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>      <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>      <span class="nv">rules:</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>          <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">messages:</span>
</span><span class='line'>        <span class="nv">password:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>        <span class="nv">email:</span>
</span><span class='line'>          <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>          <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>controllers/users_controller/check_email.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">check_email</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>     <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>My password reset codes</p>

<figure class='code'><figcaption><span>controllers/password_resets_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">send_password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.email_sent&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">new_password_reset_path</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.expired&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">permitted_params</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@identity</span> <span class="o">=</span> <span class="no">Identity</span><span class="o">.</span><span class="n">find_by</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>        <span class="vi">@identity</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
</span><span class='line'>        <span class="vi">@identity</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span>
</span><span class='line'>        <span class="k">if</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.password_has_been_reset&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.error_in_password_reset&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/password_resets/new.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span> <span class="n">form_tag</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span> <span class="k">do</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.reset_password&#39;</span><span class="p">),</span>  <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>views/password_resets/edit.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span> <span class="n">form_for</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="p">-</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="nc">.error_messages</span>
</span><span class='line'>      <span class="nt">%h2</span> Form is invalid
</span><span class='line'>      <span class="nt">%ul</span>
</span><span class='line'>        <span class="p">-</span> <span class="k">for</span> <span class="n">message</span> <span class="k">in</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
</span><span class='line'>          <span class="nt">%li</span><span class="p">=</span> <span class="n">message</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="nc">.field</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="nc">.actions</span><span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Update Password&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mailers</p>

<figure class='code'><figcaption><span>app/mailers/password_resets_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">password_reset_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>    <span class="n">mail</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.pass_reset.subject&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ow">and</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">mail</span> <span class="n">which</span> <span class="n">I</span><span class="err">’</span><span class="n">ve</span> <span class="n">only</span> <span class="n">paste</span> <span class="n">the</span> <span class="n">relevant</span> <span class="n">part</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8220;` haml app/views/mailers/password_reset.html.haml</p>

<p> #href: &ldquo;#{edit_password_reset_url(@user.password_reset_token)}&rdquo;}=t(&ldquo;.pass_reset_link_button&rdquo;)</p>

<p>So it works. At least omniauth-identity has tests..I really could not do test-driven with it so I’ll add the tests soon..</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/18/fancy-return-to-old-school-trees/">Fancy Return to Old School Trees</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/09/full-login-system-out-of-omniauth-identity-with-mongoid-and-jquery-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
