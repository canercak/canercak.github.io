
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Caner's Ruby on rails blog</title>
  <meta name="author" content="Caner">

  
  <meta name="description" content="Today's post is about creating responsive email templates using Rails partial and responsive Ink.">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://canercak.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Caner's Ruby on rails blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Caner's Ruby on rails blog</a></h1>
  
    <h2>It's all about the beauty of Ruby. I'm not a "Guru", not a "Rock Star" or "Ninja" at all. But I can do every single thing I need and I enjoy so much because I'm in love with her beauty.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:canercak.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/25/using-rails-partials-and-ink-to-create-responsive-email-templates/">Using Rails Partials and Ink to Create Responsive Email Templates</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-25T21:27:04+03:00" pubdate data-updated="true">Apr 25<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/04/25/using-rails-partials-and-ink-to-create-responsive-email-templates/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2014/04/25/using-rails-partials-and-ink-to-create-responsive-email-templates/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First we create our partials. These will be the templates that out emails going to use.
Take a look at @content part.</p>

<figure class='code'><figcaption><span>shared/_email_template.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nn">!!! Strict</span>
</span><span class='line'><span class="nt">%html</span><span class="p">{</span><span class="ss">xmlns</span><span class="p">:</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%head</span>
</span><span class='line'>    <span class="nt">%meta</span><span class="p">{</span><span class="ss">content</span><span class="p">:</span> <span class="s2">&quot;text/html; charset=utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;http-equiv&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">}/</span>
</span><span class='line'>    <span class="nt">%meta</span><span class="p">{</span><span class="ss">content</span><span class="p">:</span> <span class="s2">&quot;width=device-width&quot;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;viewport&quot;</span><span class="p">}/</span>
</span><span class='line'>  <span class="nt">%body</span>
</span><span class='line'>    <span class="nt">%table</span><span class="nc">.body</span>
</span><span class='line'>      <span class="nt">%tr</span>
</span><span class='line'>        <span class="nt">%td</span><span class="nc">.center</span><span class="p">{</span><span class="ss">align</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="ss">valign</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="nt">%center</span>
</span><span class='line'>            <span class="nt">%table</span><span class="nc">.row.header</span>
</span><span class='line'>              <span class="nt">%tr</span>
</span><span class='line'>                <span class="nt">%td</span><span class="nc">.center</span><span class="p">{</span><span class="ss">align</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">}</span>
</span><span class='line'>                  <span class="nt">%center</span>
</span><span class='line'>                    <span class="nt">%table</span><span class="nc">.container</span>
</span><span class='line'>                      <span class="nt">%tr</span>
</span><span class='line'>                        <span class="nt">%td</span><span class="nc">.wrapper.last</span>
</span><span class='line'>                          <span class="nt">%table</span><span class="nc">.twelve.columns</span>
</span><span class='line'>                            <span class="nt">%tr</span>
</span><span class='line'>                              <span class="nt">%td</span><span class="nc">.six.sub-columns</span>
</span><span class='line'>                                <span class="nt">%img</span><span class="p">{</span><span class="ss">src</span><span class="p">:</span> <span class="s2">&quot;https://s3.amazonaws.com/hizmetkutusu/hizmetkutusu.png&quot;</span><span class="p">}/</span>
</span><span class='line'>                              <span class="nt">%td</span><span class="nc">.six.sub-columns.last</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;text-align:right; vertical-align:middle;&quot;</span><span class="p">}</span>
</span><span class='line'>                                <span class="nt">%span</span><span class="nc">.template-label</span>
</span><span class='line'>                              <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>            <span class="nt">%table</span><span class="nc">.container</span>
</span><span class='line'>              <span class="nt">%tr</span>
</span><span class='line'>                <span class="nt">%td</span>
</span><span class='line'>                  <span class="nt">%table</span><span class="nc">.row</span>
</span><span class='line'>                    <span class="nt">%tr</span>
</span><span class='line'>                      <span class="nt">%td</span><span class="nc">.wrapper.last</span>
</span><span class='line'>                        <span class="nt">%table</span><span class="nc">.twelve.columns</span>
</span><span class='line'>                          <span class="nt">%tr</span>
</span><span class='line'>                            <span class="nt">%td</span>
</span><span class='line'>                              <span class="nt">%h1</span><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_title</span><span class="o">]</span>
</span><span class='line'>                              <span class="nt">%p</span><span class="nc">.lead</span><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_subtitle</span><span class="o">]</span>
</span><span class='line'>                              <span class="nt">%p</span><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_content</span><span class="o">]</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>                  <span class="nt">%table</span><span class="nc">.row.callout</span>
</span><span class='line'>                    <span class="nt">%tr</span>
</span><span class='line'>                      <span class="nt">%td</span><span class="nc">.wrapper.last</span>
</span><span class='line'>                        <span class="nt">%table</span><span class="nc">.twelve.columns</span>
</span><span class='line'>                          <span class="nt">%tr</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.panel</span>
</span><span class='line'>                              <span class="nt">%p</span>
</span><span class='line'>                                <span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_callout</span><span class="o">]</span>
</span><span class='line'>                                <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;@content[:body_link]&quot;</span><span class="p">}=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_link_title</span><span class="o">]</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>                  <span class="nt">%table</span><span class="nc">.row.footer</span>
</span><span class='line'>                    <span class="nt">%tr</span>
</span><span class='line'>                      <span class="nt">%td</span><span class="nc">.wrapper</span>
</span><span class='line'>                        <span class="nt">%table</span><span class="nc">.six.columns</span>
</span><span class='line'>                          <span class="nt">%tr</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.left-text-pad</span>
</span><span class='line'>                              <span class="nt">%h5</span><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_follow_us&#39;</span><span class="p">)</span>
</span><span class='line'>                              <span class="nt">%table</span><span class="nc">.tiny-button.facebook</span>
</span><span class='line'>                                <span class="nt">%tr</span>
</span><span class='line'>                                  <span class="nt">%td</span>
</span><span class='line'>                                    <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;https://www.facebook.com/hizmetkutusu&quot;</span><span class="p">}</span> Facebook
</span><span class='line'>                              <span class="nt">%br</span><span class="p">/</span>
</span><span class='line'>                              <span class="nt">%table</span><span class="nc">.tiny-button.twitter</span>
</span><span class='line'>                                <span class="nt">%tr</span>
</span><span class='line'>                                  <span class="nt">%td</span>
</span><span class='line'>                                    <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;https://twitter.com/hizmetkutusu&quot;</span><span class="p">}</span> Twitter
</span><span class='line'>                              <span class="nt">%br</span><span class="p">/</span>
</span><span class='line'>                              <span class="nt">%table</span><span class="nc">.tiny-button.google-plus</span>
</span><span class='line'>                                <span class="nt">%tr</span>
</span><span class='line'>                                  <span class="nt">%td</span>
</span><span class='line'>                                    <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;https://plus.google.com/u/0/b/111464930698652996593/111464930698652996593&quot;</span><span class="p">}</span> Google +
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>                      <span class="nt">%td</span><span class="nc">.wrapper.last</span>
</span><span class='line'>                        <span class="nt">%table</span><span class="nc">.six.columns</span>
</span><span class='line'>                          <span class="nt">%tr</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.last.right-text-pad</span>
</span><span class='line'>                              <span class="nt">%h5</span><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contactinfo&#39;</span><span class="p">)</span>
</span><span class='line'>                              <span class="nt">%p</span><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_phone&#39;</span><span class="p">)</span>
</span><span class='line'>                              <span class="nt">%p</span>
</span><span class='line'>                                <span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_email&#39;</span><span class="p">)</span>
</span><span class='line'>                                <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;mailto:iletisim@hizmetkutusu.com&quot;</span><span class="p">}=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_email_address&#39;</span><span class="p">)</span>
</span><span class='line'>                              <span class="nt">%p</span><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_address&#39;</span><span class="p">)</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>                  <span class="nt">%table</span><span class="nc">.row</span>
</span><span class='line'>                    <span class="nt">%tr</span>
</span><span class='line'>                      <span class="nt">%td</span><span class="nc">.wrapper.last</span>
</span><span class='line'>                        <span class="nt">%table</span><span class="nc">.twelve.columns</span>
</span><span class='line'>                          <span class="nt">%tr</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="p">{</span><span class="ss">align</span><span class="p">:</span> <span class="s2">&quot;center&quot;</span><span class="p">}</span>
</span><span class='line'>                              <span class="nt">%center</span>
</span><span class='line'>                                <span class="nt">%p</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;text-align:center;&quot;</span><span class="p">}</span>
</span><span class='line'>                                  <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;http://hizmetkutusu.com/terms&quot;</span><span class="p">}=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_terms&#39;</span><span class="p">)</span>
</span><span class='line'>                                  |
</span><span class='line'>                                  <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;http://hizmetkutusu.com/privacy&quot;</span><span class="p">}=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_privacy&#39;</span><span class="p">)</span>
</span><span class='line'>                                  |
</span><span class='line'>                                  <span class="nt">%a</span><span class="p">{</span><span class="ss">href</span><span class="p">:</span> <span class="s2">&quot;http://hizmetkutusu.com/unsubscibe&quot;</span><span class="p">}=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_unsubscribe&#39;</span><span class="p">)</span>
</span><span class='line'>                            <span class="nt">%td</span><span class="nc">.expander</span>
</span><span class='line'>                  <span class="c">/ container end below</span>
</span></code></pre></td></tr></table></div></figure>


<p>We do the same for plain text email templates</p>

<figure class='code'><figcaption><span>shared/_email_template.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">app_name</span>
</span><span class='line'>
</span><span class='line'><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_title</span><span class="o">]</span>
</span><span class='line'><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_subtitle</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_content</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">=</span><span class="vi">@content</span><span class="o">[</span><span class="ss">:body_callout</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contactinfo&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_phone&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_email&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_email_address&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_contact_address&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>Facebook
</span><span class='line'>https://www.facebook.com/hizmetkutusu
</span><span class='line'>Twitter
</span><span class='line'>https://twitter.com/hizmetkutusu
</span><span class='line'>Google+
</span><span class='line'>https://plus.google.com/u/0/b/111464930698652996593/111464930698652996593
</span><span class='line'>
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_terms&#39;</span><span class="p">)</span>
</span><span class='line'>http://hizmetkutusu.com/terms
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_privacy&#39;</span><span class="p">)</span>
</span><span class='line'>http://hizmetkutusu.com/privacy
</span><span class='line'><span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.welcome_email.welcome_user_unsubscribe&#39;</span><span class="p">)</span>
</span><span class='line'>http://hizmetkutusu.com/unsubscibe
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/mailers/registration_email.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span><span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">&#39;shared/email_template&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="vi">@content</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/mailers/registration_email.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="p">=</span><span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">&#39;shared/email_template_text&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="vi">@content</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can create our emails</p>

<figure class='code'><figcaption><span>mailers/provider_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ProviderMailer</span> <span class="o">&lt;</span> <span class="ss">ActionMailer</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Resque</span><span class="p">:</span><span class="ss">:Mailer</span>
</span><span class='line'>  <span class="n">default</span> <span class="ss">from</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">mailer</span><span class="o">.</span><span class="n">from</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new_quote_email</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
</span><span class='line'>    <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">default_locale</span>
</span><span class='line'>    <span class="vi">@provider</span><span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">provider</span><span class="o">[</span><span class="s2">&quot;_id&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">provider_url</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/hizmetsgl/</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="s1">&#39;_id&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="vi">@content</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:template_label</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.template_label&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_title</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.body_title&#39;</span><span class="p">,</span> <span class="ss">username</span><span class="p">:</span> <span class="vi">@provider</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_subtitle</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.body_subtitle&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_content</span><span class="o">]</span> <span class="o">=</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.body_content&#39;</span><span class="p">,</span> <span class="n">provider_email</span><span class="p">:</span> <span class="vi">@provider</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">provider_phone</span><span class="p">:</span> <span class="vi">@provider</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">telephone</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_callout</span><span class="o">]</span> <span class="o">=</span><span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.body_callout&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_link</span><span class="o">]</span> <span class="o">=</span> <span class="n">provider_url</span>
</span><span class='line'>    <span class="vi">@content</span><span class="o">[</span><span class="ss">:body_link_title</span><span class="o">]</span> <span class="o">=</span><span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.body_link_title&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mail</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="n">provider</span><span class="o">[</span><span class="s2">&quot;business_email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;provider_mailer.new_quote_email.subject&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/15/forget-about-carrierwave-and-paperclip/">Forget About Carrierwave and Paperclip, Use Transloadit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-15T00:21:48+03:00" pubdate data-updated="true">Apr 15<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/04/15/forget-about-carrierwave-and-paperclip/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2014/04/15/forget-about-carrierwave-and-paperclip/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today&rsquo;s post is about lovable transloadit. What is transloadit and why it is lovable? Well,
if you have anything to upload then transloadit sorts out the processing, encoding
,bandwidth that your server may face and this is just the start. Say you have videos;
transloadit uploads, processes, encodes, crops, watermarks, exports, etc.
Same for images, sounds, pdfs, rars and almost all.
You don&rsquo;t have to use carrierwave-imagemagick-paperclip, create an uploader classes,
allocate gridfs storages and lock your heroku dynos on upload times.
Some people integrate it with paperclip maybe for keeping the uploaded file on page after callback
but I think its uncesesary &ndash; check my code you can sort that too.
So don&rsquo;t even think about anything else, it does all and provides you the link of the file.
Yes it&rsquo;s paid(like 20$ a month) but when you compare it with your server costs and the hassle of dealing with files it will definetely be cheaper.</p>

<p>I had to create a system where user uploads videos and admin controls them.
It&rsquo;s actually more complicated than that but knowing that will give you an idea.</p>

<p>We start with creating a template file on transloadit website. You just start with their free plan.
Here is the template that I created on their wesite. I&rsquo;m encoidng iphone videos,taking out 25 thumbnails out
of every video and exporting them to our s3 bucket.</p>

<figure class='code'><figcaption><span>transloadit template</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;steps&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;iphone_video&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;:original&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;robot&quot;</span><span class="p">:</span> <span class="s2">&quot;/video/encode&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;preset&quot;</span><span class="p">:</span> <span class="s2">&quot;iphone&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ffmpeg&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;120000K&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;thumbnails&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;:original&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;robot&quot;</span><span class="p">:</span> <span class="s2">&quot;/video/thumbs&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;width&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;height&quot;</span><span class="p">:</span> <span class="mi">250</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;export&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;robot&quot;</span><span class="p">:</span> <span class="s2">&quot;/s3/store&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;use&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;iphone_video&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;thumbnails&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;xxxxx&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;secret&quot;</span><span class="p">:</span> <span class="s2">&quot;yyyyyy&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;bucket&quot;</span><span class="p">:</span> <span class="s2">&quot;zzzzzz&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>transloadit gem  provides the necessary integration with Rails so I use it rather than the js library.</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;transloadit-rails&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The gem creates a yml file where we store our template details.
The details can be found on transloadit website dashboard.</p>

<figure class='code'><figcaption><span>config/transloadit.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'>  <span class="n">jquery_sdk_version</span><span class="p">:</span> <span class="s1">&#39;latest&#39;</span>
</span><span class='line'>  <span class="ss">auth</span><span class="p">:</span>
</span><span class='line'>    <span class="n">key</span>     <span class="p">:</span> <span class="s1">&#39;wwww&#39;</span>
</span><span class='line'>    <span class="n">secret</span>  <span class="p">:</span> <span class="s1">&#39;ssssss&#39;</span>
</span><span class='line'>    <span class="ss">duration</span><span class="p">:</span> <span class="mi">1800</span>
</span><span class='line'>    <span class="n">max_size</span><span class="p">:</span> <span class="mi">52428800</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">templates</span><span class="p">:</span>
</span><span class='line'>    <span class="n">video_encode</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxx&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'>  <span class="n">jquery_sdk_version</span><span class="p">:</span> <span class="s1">&#39;latest&#39;</span>
</span><span class='line'>  <span class="ss">auth</span><span class="p">:</span>
</span><span class='line'>    <span class="n">key</span>     <span class="p">:</span> <span class="s1">&#39;wwww&#39;</span>
</span><span class='line'>    <span class="n">secret</span>  <span class="p">:</span> <span class="s1">&#39;ssssss&#39;</span>
</span><span class='line'>    <span class="ss">duration</span><span class="p">:</span> <span class="mi">1800</span>
</span><span class='line'>    <span class="n">max_size</span><span class="p">:</span> <span class="mi">52428800</span>
</span><span class='line'>
</span><span class='line'>  <span class="ss">templates</span><span class="p">:</span>
</span><span class='line'>    <span class="n">video_encode</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxx&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is my form to upload files. Each apr has one jasny uploader.
I intentionaly don&rsquo;t do multiple uploads here since the feature is making user upload one by one.
Check how I place necessary transloadit codes. First refers to transloadit.yml and second refers to
transloadit jquery uploader. Once the user selects the file, the form submits(triggeronselection =>true)
and upload starts so you will see a progress bar(modal=>true). &ldquo;wait=>true&rdquo; means that I want transloadit to
process the files after the upload finishes. Once its false it will just upload the file and queue the processing
on their server so you can use hooks to get processed files.</p>

<figure class='code'><figcaption><span>views/aprs/_form.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#update_container</span>
</span><span class='line'>  <span class="p">-</span> <span class="k">if</span> <span class="vi">@aprs</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>    <span class="p">-</span> <span class="vi">@aprs</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">apr</span><span class="p">,</span><span class="n">index</span><span class="o">|</span>
</span><span class='line'>      <span class="p">=</span> <span class="n">bootstrap_form_for</span> <span class="n">apr</span><span class="p">,</span> <span class="ss">:remote</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">html</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;showapr</span><span class="si">#{</span><span class="n">apr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-horizontal&#39;</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>        <span class="p">=</span> <span class="n">f</span><span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>        <span class="p">=</span> <span class="n">hidden_field_tag</span> <span class="ss">:eventid</span><span class="p">,</span> <span class="n">apr</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>        <span class="p">=</span> <span class="n">transloadit</span> <span class="ss">:video_encode</span>
</span><span class='line'>        <span class="nc">.fileupload.fileupload-new.pull-left</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;padding-right: 5px;&quot;</span><span class="p">,</span> <span class="s2">&quot;data-provides&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;fileupload&quot;</span> <span class="p">}</span>
</span><span class='line'>          <span class="nc">.fileupload-new.thumbnail</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;width: 130px; height: 130px;&quot;</span><span class="p">}</span>
</span><span class='line'>            <span class="p">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>              <span class="p">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">].</span><span class="n">present?</span>
</span><span class='line'>                <span class="nt">%img</span><span class="p">{</span> <span class="ss">:src</span> <span class="o">=&gt;</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">}/</span>
</span><span class='line'>          <span class="p">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">check_user_failed</span> <span class="o">==</span> <span class="kp">false</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">apr</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
</span><span class='line'>            <span class="nc">.fileupload-preview.fileupload-exists.thumbnail</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">&quot;width: 130px; height: 130px;&quot;</span><span class="p">}</span>
</span><span class='line'>            <span class="nt">%div</span>
</span><span class='line'>              <span class="nt">%span</span><span class="nc">.btn.btn-file</span>
</span><span class='line'>                <span class="nt">%span</span><span class="nc">.fileupload-new</span><span class="p">{</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">&quot;selectbutton&quot;</span><span class="p">}</span>
</span><span class='line'>                  <span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;select_video&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="nt">%span</span><span class="nc">.fileupload-exists</span>
</span><span class='line'>                  <span class="p">=</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;select_video&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="p">=</span><span class="n">f</span><span class="o">.</span><span class="n">file_field</span> <span class="s2">&quot;upload</span><span class="si">#{</span><span class="n">apr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="ss">accept</span><span class="p">:</span> <span class="s1">&#39;video/flv,video/avi,video/mov,video/mp4,video/mpg,video/wmv,video/3gp,video/asf,video/rm,video/swf&#39;</span><span class="p">,</span>  <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:max_file_size</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="o">.</span><span class="n">megabytes</span><span class="p">}</span>
</span><span class='line'>            <span class="p">=</span> <span class="n">transloadit_jquerify</span> <span class="s2">&quot;showapr</span><span class="si">#{</span><span class="n">apr</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">:wait</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:modal</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span> <span class="ss">triggerUploadOnFileSelection</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="p">-</span><span class="k">else</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">label_tag</span> <span class="ss">:error_label</span><span class="p">,</span> <span class="s2">&quot;time doesn&#39;t fit to update time&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is my controller. I include the ParamsDecoder to make encoding work. Once the upload finishes you will get a
long json (params[:transloadit]). It has almost every details you can find about the uploaded files.</p>

<figure class='code'><figcaption><span>controllers/aprs_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AprsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Transloadit</span><span class="p">:</span><span class="ss">:Rails</span><span class="o">::</span><span class="no">ParamsDecoder</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">AprsHelper</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;events._id&#39;</span> <span class="o">=&gt;</span> <span class="ss">Moped</span><span class="p">:</span><span class="ss">:BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:eventid</span><span class="o">]</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">unless</span>  <span class="n">app</span><span class="o">.</span><span class="n">check_user_failed</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">event</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">pr</span><span class="o">|</span> <span class="n">pr</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="n">params</span><span class="o">[</span><span class="ss">:eventid</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">apr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">aprs</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">pr</span><span class="o">|</span> <span class="n">pr</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">isvalid</span> <span class="o">=</span> <span class="n">check_video_validity</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:transloadit</span><span class="o">]</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">isvalid</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>        <span class="n">videos</span> <span class="o">=</span> <span class="n">transloadit_file_uploads</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:transloadit</span><span class="o">]</span><span class="p">,</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">videos</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>          <span class="n">apr</span><span class="o">.</span><span class="n">upload</span> <span class="o">=</span> <span class="n">videos</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;You&#39;ve already uploaded a video&quot;</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>          <span class="n">blank</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">aprs</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">evt</span><span class="o">|</span> <span class="n">evt</span><span class="o">.</span><span class="n">upload</span><span class="p">;</span> <span class="n">evt</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">blank?</span><span class="p">}</span>
</span><span class='line'>          <span class="k">unless</span> <span class="n">blank</span><span class="o">.</span><span class="n">include?</span> <span class="kp">true</span>
</span><span class='line'>            <span class="n">event</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
</span><span class='line'>            <span class="n">event</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>            <span class="vi">@aprs</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">aprs</span>
</span><span class='line'>            <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>         <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Time of upload is out of event times&quot;</span>
</span><span class='line'>         <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@aprs</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>          <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;user failed&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>This is special for my case. As you see I compare the metadata of the video I get from transloadit params.
We assume that all uploaded videos have create dates. All videos coming from phones and recording devices have them.
I compare create date of the video and upload time with the event times.
So transloadit enables me to check if the video has uploaded between specific times(start-end times of an event).</p>

<figure class='code'><figcaption><span>helpers/aprs_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">def</span> <span class="nf">check_video_validity</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span class='line'>    <span class="n">check_hourly</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">check_hourly</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span class='line'>    <span class="n">date_created</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:uploads</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="ss">:meta</span><span class="o">][</span><span class="ss">:date_file_created</span><span class="o">]</span>
</span><span class='line'>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">in_time_zone</span>
</span><span class='line'>    <span class="n">end_time</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">in_time_zone</span>
</span><span class='line'>    <span class="n">upload_time</span> <span class="o">=</span><span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:last_job_completed</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">in_time_zone</span>
</span><span class='line'>    <span class="n">valid</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">date_created</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">date_created</span> <span class="o">&gt;=</span> <span class="n">start_time</span> <span class="o">&amp;&amp;</span> <span class="n">date_created</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>         <span class="p">(</span><span class="n">upload_time</span> <span class="o">&gt;=</span> <span class="n">start_time</span> <span class="o">&amp;&amp;</span> <span class="n">upload_time</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span>
</span><span class='line'>        <span class="n">valid</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">valid</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is how I store the links on mongodb. &ldquo;upload&rdquo; is a mongoid hash field and things will be stored here.</p>

<figure class='code'><figcaption><span>helpers/aprs_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">transloadit_file_uploads</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">upload</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:results</span><span class="o">][</span><span class="ss">:thumbnails</span><span class="o">].</span><span class="n">blank?</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">upload</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'>      <span class="n">upload</span><span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]=[]</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">upload</span><span class="o">[</span><span class="ss">:video</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:results</span><span class="o">][</span><span class="ss">:iphone_video</span><span class="o">].</span><span class="n">first</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
</span><span class='line'>    <span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">params</span><span class="o">[</span><span class="ss">:results</span><span class="o">][</span><span class="ss">:thumbnails</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">thumb</span><span class="o">|</span>
</span><span class='line'>        <span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">thumb</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">upload</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>So after the links get saved its time to show the videos with flowplayer.
I have a partial with video, thumbnail carousel and accept-reject buttons in it.
By the way if you discover owl-carousel you won&rsquo;t be using bootstrap carousel anymore.
I won&rsquo;t go into detail of jquery partial updates, carousel and flowplayer integration since this post is about transloadit.
Check their websites for more information. I had to use coffescript inline because of variables used in partials. You can take out the js parts outside for sure.
We did not need else conditions intentionally.</p>

<figure class='code'><figcaption><span>admin/events/_show_adminevent.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#update_container</span>
</span><span class='line'>  <span class="o">.</span><span class="n">row</span>
</span><span class='line'>    <span class="o">.</span><span class="n">span8</span>
</span><span class='line'>      <span class="o">-</span> <span class="k">if</span> <span class="vi">@aprs</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>        <span class="o">-</span> <span class="vi">@aprs</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">apr</span><span class="p">,</span><span class="n">index</span><span class="o">|</span>
</span><span class='line'>          <span class="o">=</span> <span class="n">bootstrap_form_for</span> <span class="n">apr</span><span class="p">,</span><span class="ss">:remote</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">admin_apr_path</span><span class="p">(</span><span class="n">apr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">,</span><span class="ss">html</span><span class="p">:</span> <span class="p">{</span><span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:put</span><span class="p">,</span>  <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;form-horizontal&#39;</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>            <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>            <span class="o">%</span><span class="n">legend</span> <span class="no">Set</span> <span class="c1">#{index+1}</span>
</span><span class='line'>            <span class="o">%</span><span class="n">fieldset</span>
</span><span class='line'>              <span class="o">.</span><span class="n">control</span><span class="o">-</span><span class="n">group</span>
</span><span class='line'>                <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:videos</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.videos&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'>                <span class="o">.</span><span class="n">controls</span>
</span><span class='line'>                  <span class="o">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>                    <span class="o">.</span><span class="n">span8</span>
</span><span class='line'>                      <span class="o">.</span><span class="n">player</span><span class="p">{</span><span class="s2">&quot;data-ratio&quot;</span> <span class="o">=&gt;</span><span class="s2">&quot;0.417&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="o">=&gt;</span><span class="s2">&quot;player_</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">:style</span><span class="o">=&gt;</span><span class="s2">&quot;background:#777 url(</span><span class="si">#{</span><span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">].</span><span class="n">first</span><span class="si">}</span><span class="s2">) no-repeat center;  background-size: cover;&quot;</span><span class="p">}</span>
</span><span class='line'>                        <span class="ss">:coffee</span>
</span><span class='line'>                          <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#player_</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flowplayer</span>
</span><span class='line'>                            <span class="ss">ratio</span><span class="p">:</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span>
</span><span class='line'>                            <span class="ss">splash</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>                            <span class="ss">rtmp</span><span class="p">:</span> <span class="s2">&quot;rtmp://s3b78u0kbtx79q.cloudfront.net/cfx/st&quot;</span>
</span><span class='line'>                            <span class="ss">playlist</span><span class="p">:</span> <span class="o">[[</span><span class="ss">mp4</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">[</span><span class="s2">&quot;video&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]]</span>
</span><span class='line'>                          <span class="k">return</span>
</span><span class='line'>              <span class="o">=</span><span class="n">hidden_field_tag</span> <span class="s2">&quot;eventid&quot;</span><span class="p">,</span> <span class="n">apr</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">id</span>
</span><span class='line'>              <span class="o">.</span><span class="n">control</span><span class="o">-</span><span class="n">group</span>
</span><span class='line'>                <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:thumbnails</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.thumbnails&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'>                <span class="o">.</span><span class="n">controls</span>
</span><span class='line'>                  <span class="o">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>                    <span class="o">.</span><span class="n">span8</span>
</span><span class='line'>                      <span class="o">.</span><span class="n">owl</span><span class="o">-</span><span class="n">demo</span><span class="o">.</span><span class="n">owl</span><span class="o">-</span><span class="n">carousel</span><span class="p">{</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="s2">&quot;thumbnails_</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>                        <span class="o">-</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">[</span><span class="s2">&quot;thumbs&quot;</span><span class="o">].</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">thumb</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>                          <span class="o">.</span><span class="n">item</span>
</span><span class='line'>                            <span class="o">%</span><span class="n">img</span><span class="o">.</span><span class="n">lazyOwl</span><span class="p">{</span><span class="ss">alt</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="ss">width</span><span class="p">:</span><span class="mi">250</span><span class="p">,</span> <span class="ss">height</span><span class="p">:</span><span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;data-src&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">thumb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span><span class="o">/</span>
</span><span class='line'>                        <span class="ss">:coffee</span>
</span><span class='line'>                          <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#thumbnails_</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">owlCarousel</span>
</span><span class='line'>                            <span class="ss">items</span><span class="p">:</span> <span class="mi">5</span>
</span><span class='line'>                            <span class="ss">lazyLoad</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>                            <span class="ss">navigation</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>              <span class="o">.</span><span class="n">control</span><span class="o">-</span><span class="n">group</span>
</span><span class='line'>                <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:confirmation</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;.confirmation&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span>
</span><span class='line'>                <span class="o">.</span><span class="n">controls</span>
</span><span class='line'>                  <span class="o">-</span> <span class="k">if</span> <span class="n">apr</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>                    <span class="o">-</span> <span class="k">if</span>  <span class="n">apr</span><span class="o">.</span><span class="n">confirmations</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:confirmed_user</span><span class="o">=&gt;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>                      <span class="o">-</span> <span class="k">if</span>  <span class="n">apr</span><span class="o">.</span><span class="n">confirmations</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:confirmed_user</span><span class="o">=&gt;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">==</span> <span class="kp">true</span>
</span><span class='line'>                        <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Accepted&quot;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;accept&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-success&#39;</span>
</span><span class='line'>                        <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Reject&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span> <span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">confirm</span><span class="p">:</span> <span class="s2">&quot;Are you sure?&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we go.</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_045.png"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/09/using-omniauth-identity-with-jquery-clientside-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-09T12:30:10+02:00" pubdate data-updated="true">Feb 9<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/02/09/using-omniauth-identity-with-jquery-clientside-validations/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2014/02/09/using-omniauth-identity-with-jquery-clientside-validations/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I want to start this post with one definite sentence.
Don&rsquo;t use omniauth-identity!
Why? Because it doesn&rsquo;t cover the &ldquo;details&rdquo; of a login system. And for a login system details are absolutely necesssary. It does make the user register and sign-in
but thats all. No forms, no password resets, no emails, no decent validations, etc. It&rsquo;s really simple and that simplicity won&rsquo;t help you. And the worst thing is it&rsquo;s hard to customise.
You have that initialiser file and you don&rsquo;t understand what you do in there. There are also no resources other than Ryan&rsquo;s Railscast and couple of blog posts.
The reason I&rsquo;m writing this blog post is because there may be people still wan&rsquo;t to use it as I do.
I&rsquo;ve lost considerable amount of time dealing with it&rsquo;s login fail bug,
integrating it and making a decent login system out of it and now after all that time
I don&rsquo;t want to deal with login systems at all.</p>

<p>So we start with adding the gem</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;omniauth&quot;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-identity&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we have this initialiser file also used in other omniauth providers. That line fixes the bug..</p>

<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">on_failure</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span>
</span><span class='line'>  <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:FailureEndpoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">redirect_to_failure</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The we create the modal and yes it doesn&rsquo;t directly integrate with
your user model(or I didn&rsquo;t lost time trying to do it).
You will have a seperate mongoid collection and it will store identities</p>

<figure class='code'><figcaption><span>models/identity.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Identity</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:Identity</span><span class="o">::</span><span class="ss">Models</span><span class="p">:</span><span class="ss">:Mongoid</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">validate</span> <span class="ss">:uniqueness_of_email</span>
</span><span class='line'>  <span class="n">validates_format_of</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="sr">/^[-a-z0-9_+\.]+\@([-a-z0-9]+\.)+[a-z0-9]{2,4}$/i</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">uniqueness_of_email</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="s2">&quot;email is already in use&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have authentication file in models directory that also manages omniauth facebook so after saving the identity
don&rsquo;t forget to save the user too. I&rsquo;m setting user&rsquo;s provider as &ldquo;identity&rdquo;, since I only get name and email I had to set uid as username.</p>

<figure class='code'><figcaption><span>models/concerns/user/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>          <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">new_record?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">user</span><span class="o">.</span><span class="n">has_access?</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span><span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>            <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">login_count</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>            <span class="no">UserMailer</span><span class="o">.</span><span class="n">welcome_email</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">first</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="n">user</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Controller only has new method.  Taken from Ryan&rsquo;s railcast.</p>

<figure class='code'><figcaption><span>controllers/identities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'> <span class="k">class</span> <span class="nc">IdentitiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="vi">@identity</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.identity&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@user</span> <span class="o">=</span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>sessions controller as usual</p>

<figure class='code'><figcaption><span>controllers/sessions_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">skip_before_filter</span> <span class="ss">:require_login</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="o">[</span><span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">from_omniauth</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:redirect_to</span><span class="p">)</span> <span class="o">||</span> <span class="n">new_quote_path</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">failure</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">flash</span><span class="p">:</span> <span class="p">{</span> <span class="ss">error</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">restricted_group_id</span> <span class="p">?</span> <span class="s1">&#39;flash.sessions.error.restricted&#39;</span> <span class="p">:</span> <span class="s1">&#39;flash.sessions.error.create&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use modals to show forms</p>

<figure class='code'><figcaption><span>views/pages/home.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>    <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;register_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#new-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nt">%big</span><span class="nc">.inline-block.new-identity</span> veya
</span><span class='line'>    <span class="nt">%big</span><span class="nc">.inline-block.login-identity</span><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_now&#39;</span><span class="p">),</span> <span class="s1">&#39;#login-identity&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">toggle</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/shared/_modal_login_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#login-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">render</span> <span class="s1">&#39;identities/login&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/shared/_modal_new_identity.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nf">#new-identity</span><span class="nc">.modal.hide.fade</span><span class="p">{</span> <span class="ss">tabindex</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">role</span><span class="p">:</span> <span class="s1">&#39;dialog&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-labelledby&#39;</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;new_identity&#39;</span><span class="p">),</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="nc">.modal-header</span>
</span><span class='line'>    <span class="nt">%button</span><span class="nc">.close</span><span class="p">{</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">}</span>, &#39;aria-hidden&#39; =&gt; true } &amp;times;
</span><span class='line'>    <span class="nt">%h3</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.new_identity&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nc">.modal-body</span>
</span><span class='line'>    <span class="p">=</span><span class="n">render</span> <span class="s1">&#39;identities/register&#39;</span>
</span><span class='line'>  <span class="nc">.modal-footer</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">),</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-hidden&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">dismiss</span><span class="p">:</span> <span class="s1">&#39;modal&#39;</span> <span class="p">},</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/identities/_login.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span><span class="n">form_tag</span><span class="p">(</span><span class="s1">&#39;/auth/identity/callback&#39;</span><span class="p">,</span>  <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;actual-login-form&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:login_error</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;control-label&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;error_code_label_login&#39;</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:auth_key</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:auth_key</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="kp">nil</span>
</span><span class='line'>  <span class="o">.</span><span class="n">actions</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.login&#39;</span><span class="p">),</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;login_submit&quot;</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">%</span><span class="n">br</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.forgot_password&#39;</span><span class="p">),</span> <span class="n">new_password_reset_path</span>
</span><span class='line'><span class="o">-</span> <span class="k">if</span> <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">==</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;shared.navbar.wrong_password&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:coffee</span>
</span><span class='line'>    <span class="err">$</span><span class="p">(</span><span class="n">document</span><span class="p">)</span><span class="o">.</span><span class="n">on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#login-identity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">modal</span> <span class="s2">&quot;show&quot;</span>
</span><span class='line'>      <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#error_code_label_login&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>      <span class="err">$</span><span class="p">(</span><span class="s2">&quot;#password&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">focus</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/identities/_register.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">form_tag</span> <span class="s2">&quot;/auth/identity/register&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s1">&#39;signupForm&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="vi">@identity</span> <span class="o">&amp;&amp;</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>      <span class="o">%</span><span class="n">h2</span>
</span><span class='line'>        <span class="o">=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">prohibited</span> <span class="n">this</span> <span class="n">account</span> <span class="n">from</span> <span class="n">being</span> <span class="ss">saved</span><span class="p">:</span>
</span><span class='line'>      <span class="o">%</span><span class="n">ul</span>
</span><span class='line'>        <span class="o">-</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>          <span class="o">%</span><span class="n">li</span><span class="o">=</span> <span class="n">msg</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.name&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:password_confirmation</span><span class="p">,</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.password_again&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">password_field_tag</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.register&#39;</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>I use jquery validation which I love</p>

<figure class='code'><figcaption><span>pages.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;ready&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">signupForm&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>    <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>    <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>    <span class="nv">rules:</span>
</span><span class='line'>      <span class="nv">name: </span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">email:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">remote: </span><span class="s">&quot;/users/check_email&quot;</span>
</span><span class='line'>      <span class="nv">password:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>      <span class="nv">password_confirmation:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">minlength: </span><span class="mi">5</span>
</span><span class='line'>        <span class="nv">equalTo: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">password&quot;</span>
</span><span class='line'>    <span class="nv">messages:</span>
</span><span class='line'>      <span class="nv">name: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name.required&quot;</span>
</span><span class='line'>      <span class="nv">password:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>        <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password.minlength&quot;</span>
</span><span class='line'>      <span class="nv">password_confirmation:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.required&quot;</span>
</span><span class='line'>        <span class="nv">minlength: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.minlength&quot;</span>
</span><span class='line'>        <span class="nv">equalTo: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.password_confirmation.equalTo&quot;</span>
</span><span class='line'>      <span class="nv">email:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>        <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span><span class='line'>        <span class="nv">remote: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.remote&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">actual-login-form&quot;</span><span class="p">).</span><span class="nx">validate</span>
</span><span class='line'>    <span class="nv">errorClass: </span><span class="s">&quot;error_class&quot;</span>
</span><span class='line'>    <span class="nv">validClass: </span><span class="s">&quot;valid_class&quot;</span>
</span><span class='line'>    <span class="nv">rules:</span>
</span><span class='line'>      <span class="nv">email:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>        <span class="nv">email: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">password:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="kc">true</span>
</span><span class='line'>    <span class="nv">messages:</span>
</span><span class='line'>      <span class="nv">password:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.name&quot;</span>
</span><span class='line'>      <span class="nv">email:</span>
</span><span class='line'>        <span class="nv">required: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.required&quot;</span>
</span><span class='line'>        <span class="nv">email: </span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;signup.email.email&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>controllers/users_controller/check_email.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">check_email</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>     <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>My password reset codes</p>

<figure class='code'><figcaption><span>controllers/password_resets_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PasswordResetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">send_password_reset</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.email_sent&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="n">password_reset_token</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_sent_at</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">.</span><span class="n">hours</span><span class="o">.</span><span class="n">ago</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">new_password_reset_path</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.expired&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">permitted_params</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@identity</span> <span class="o">=</span> <span class="no">Identity</span><span class="o">.</span><span class="n">find_by</span> <span class="ss">email</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>      <span class="vi">@identity</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
</span><span class='line'>      <span class="vi">@identity</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@identity</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.password_has_been_reset&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="no">I18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;password_resets.error_in_password_reset&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/password_resets/new.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">form_tag</span> <span class="n">password_resets_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:post</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">label_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.email&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">text_field_tag</span> <span class="ss">:email</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>  <span class="o">=</span> <span class="n">submit_tag</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;shared.navbar.reset_password&#39;</span><span class="p">),</span>  <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-primary&#39;</span><span class="p">,</span> <span class="n">disable_with</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;helpers.disable_with&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/password_resets/edit.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">=</span> <span class="n">form_for</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">password_reset_path</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="o">-</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>    <span class="o">.</span><span class="n">error_messages</span>
</span><span class='line'>      <span class="o">%</span><span class="n">h2</span> <span class="no">Form</span> <span class="n">is</span> <span class="n">invalid</span>
</span><span class='line'>      <span class="o">%</span><span class="n">ul</span>
</span><span class='line'>        <span class="o">-</span> <span class="k">for</span> <span class="n">message</span> <span class="k">in</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
</span><span class='line'>          <span class="o">%</span><span class="n">li</span><span class="o">=</span> <span class="n">message</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span>
</span><span class='line'>  <span class="o">.</span><span class="n">field</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>    <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span>
</span><span class='line'>  <span class="o">.</span><span class="n">actions</span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Update Password&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mailers</p>

<figure class='code'><figcaption><span>app/mailers/password_resets_mailer.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">password_reset_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="nb">binding</span><span class="o">.</span><span class="n">pry</span>
</span><span class='line'>    <span class="n">mail</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;user_mailer.pass_reset.subject&#39;</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the actual mail which I&rsquo;ve only paste the relevant part</p>

<figure class='code'><figcaption><span>app/views/mailers/password_reset.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'> <span class="nf">#href:</span> &quot;<span class="si">#{</span><span class="n">edit_password_reset_url</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password_reset_token</span><span class="p">)</span><span class="si">}</span>&quot;}=t(&quot;.pass_reset_link_button&quot;)
</span></code></pre></td></tr></table></div></figure>


<p>So it works. At least omniauth-identity has tests..I really could not do test-driven with it  so I&rsquo;ll add the tests soon..</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth, Facebook, Koala and Resque</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-03T22:37:12+02:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2014</time>
        
           | <a href="/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Data is the key to long-lasting relationship with users. The more, the better. Once we have relevant data;
we can target marketing, develop features tailored to specific users and make users trust each other.
So how do we collect relevant data? There is an easy way. It&rsquo;s Facebook.</p>

<p>First, talk with your solicitor to add your Terms&amp;Conditions document that you are collecting data by using facebook.
Then make a big &ldquo;Login with Facebook&rdquo; button on your landing page. Don&rsquo;t forget to write that the user accepts the conditions
once the button clicked. Something like this:</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_044.png"></p>

<p>Then you are ready to go. I use three gems to collect data:
omniauth, omniauth-facebook and koala. For config settings there is simple config and for caching data I use resque.
I know that using devise could be easier. But simply, its big.(I have omniauth-identity for nonfacebook logins)
So this will be different than devise&rsquo;s way.</p>

<p>Here we define our facebook app details. Sensitive data is stored on local.rb file and Simpleconfig serves them to environments. Checkout simpleconfig for details.</p>

<figure class='code'><figcaption><span>config/settings/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SimpleConfig</span><span class="o">.</span><span class="n">for</span> <span class="ss">:application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">group</span> <span class="ss">:facebook</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:namespace</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_NAMESPACE&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_id</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_APP_ID&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:app_secret</span><span class="p">,</span> <span class="s1">&#39;FACEBOOK_SECRET&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:scope</span><span class="p">,</span> <span class="s1">&#39;email, publish_stream, user_birthday, user_about_me, user_education_history, user_interests, user_likes, user_religion_politics, user_work_history&#39;</span>
</span><span class='line'>    <span class="n">set</span> <span class="ss">:cache_expiry_time</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="n">days</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are omniauth initialisation details. You can learn more about omniauth on it&rsquo;s github page.</p>

<figure class='code'><figcaption><span>config/initialisers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">OmniAuth</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>    <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span>
</span><span class='line'>    <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">app_secret</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span> <span class="ss">scope</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">scope</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The haml view for our big facebook button.</p>

<figure class='code'><figcaption><span>views/pages/_facebook_login.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'>
</span><span class='line'><span class="nc">.hidden-phone</span>
</span><span class='line'>  <span class="p">=</span> <span class="n">link_to</span> <span class="n">auth_at_provider_path</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="ss">:facebook</span><span class="p">),</span> <span class="ss">class</span><span class="p">:</span> <span class="s1">&#39;btn btn-large btn-facebook&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon-facebook-sign.icon-large</span>
</span><span class='line'>    <span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;login_with_facebook&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nt">%p</span><span class="nc">.signin-terms</span>
</span><span class='line'>  <span class="nt">%b</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;we_will_never_post&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nt">%br</span><span class="p">=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;pages.home.signin_terms&#39;</span><span class="p">,</span> <span class="ss">appname</span><span class="p">:</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">terms_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;terms&#39;</span><span class="p">),</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:&quot;no-turbolink&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}),</span> <span class="n">policy_link</span><span class="p">:</span> <span class="n">link_to</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;policy&#39;</span><span class="p">),</span> <span class="ss">:policy</span><span class="p">,</span> <span class="ss">:target</span><span class="o">=&gt;</span> <span class="s1">&#39;_blank&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">html_safe</span>
</span></code></pre></td></tr></table></div></figure>


<p>Necassary routes to manage sessions</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Sessions</span>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#new&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:auth_at_provider</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/:provider/callback&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#create&#39;</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;auth/failure&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;signout&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:logout</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the user model. Removed the nonrelevant fields. As you can see I&rsquo;m collecting enough data to make decisions.</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="ss">Concerns</span><span class="p">:</span><span class="ss">:User</span><span class="o">::</span><span class="no">Authentication</span>
</span><span class='line'>  <span class="kp">include</span> <span class="o">::</span><span class="ss">Concerns</span><span class="p">:</span><span class="ss">:User</span><span class="o">::</span><span class="no">Facebook</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:provider</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:uid</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_token</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:oauth_expires_at</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_permissions</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_friends</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_favorites</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">DateTime</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s1">&#39;2014-01-01&#39;</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:gender</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:username</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:bio</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:languages</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:birthday</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Date</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:work</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:education</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:email</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:facebook_verified</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="no">Boolean</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the module for facebook authentication. This will collect facebook user data before saving the user.</p>

<figure class='code'><figcaption><span>app/models/concerns/authentication.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Authentication</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_fields_from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>          <span class="n">set_credentials</span> <span class="n">auth</span><span class="o">.</span><span class="n">credentials</span>
</span><span class='line'>          <span class="n">set_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">info</span>
</span><span class='line'>          <span class="n">set_extra_raw_info</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>          <span class="n">set_extra_raw_info_special_permissions</span> <span class="n">auth</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">raw_info</span>
</span><span class='line'>          <span class="n">set_permissions</span>
</span><span class='line'>          <span class="no">Resque</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="no">FacebookDataCacher</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="ss">Redis</span><span class="p">:</span><span class="ss">:CannotConnectError</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="kp">private</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">oauth_expires_at</span> <span class="o">=</span>  <span class="no">Time</span><span class="o">.</span><span class="n">at</span> <span class="n">credentials</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">||</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">facebook_verified</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">verified</span> <span class="o">||</span> <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_extra_raw_info</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">username</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">gender</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">gender</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">bio</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">bio</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">languages</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">languages</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_extra_raw_info_special_permissions</span><span class="p">(</span><span class="n">raw_info</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">birthday</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span><span class="p">,</span> <span class="s2">&quot;%m/%d/%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">at_midnight</span> <span class="k">if</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">birthday</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">work</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">work</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">education</span> <span class="o">=</span> <span class="n">raw_info</span><span class="o">.</span><span class="n">education</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">set_permissions</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="nb">self</span><span class="o">.</span><span class="n">facebook_permissions</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;permissions&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">from_omniauth</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'>          <span class="n">user</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">))</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">provider</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">uid</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">set_fields_from_omniauth</span> <span class="n">auth</span>
</span><span class='line'>          <span class="n">user</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'>          <span class="n">user</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This module is for caching data. I&rsquo;m making resque collect more and more details.
We will run resque workers to get them.
You can also schedule the process with resque scheduler.
Checkout facebook graph api for more data to get.
And checkout resque gem for details.</p>

<figure class='code'><figcaption><span>app/models/concerns/facebook.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concerns</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">User</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">Facebook</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">facebook</span>
</span><span class='line'>          <span class="vi">@facebook</span> <span class="o">||=</span> <span class="ss">Koala</span><span class="p">:</span><span class="ss">:Facebook</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">block_given?</span> <span class="p">?</span> <span class="k">yield</span><span class="p">(</span><span class="vi">@facebook</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@facebook</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="ss">Koala</span><span class="p">:</span><span class="ss">:Facebook</span><span class="o">::</span><span class="no">APIError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">has_facebook_permission?</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>           <span class="n">facebook_permissions</span><span class="o">[</span><span class="n">scope</span><span class="o">.</span><span class="n">to_s</span><span class="o">].</span><span class="n">to_i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">facebook_permissions?</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">cache_facebook_data?</span>
</span><span class='line'>          <span class="n">favorites</span> <span class="o">=</span> <span class="sx">%w(music books movies television games activities interests)</span>
</span><span class='line'>          <span class="n">facebook</span> <span class="k">do</span> <span class="o">|</span><span class="n">fb</span><span class="o">|</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">batch</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch_api</span><span class="o">|</span>
</span><span class='line'>              <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="s1">&#39;friends&#39;</span><span class="p">)</span>
</span><span class='line'>              <span class="n">favorites</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">favorite</span><span class="o">|</span>
</span><span class='line'>                <span class="n">batch_api</span><span class="o">.</span><span class="n">get_connections</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">,</span> <span class="n">favorite</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>               <span class="nb">self</span><span class="o">.</span><span class="n">facebook_friends</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="nb">self</span><span class="o">.</span><span class="n">facebook_favorites</span> <span class="o">=</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">?</span> <span class="n">result</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">flatten</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'>              <span class="k">return</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">false</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a resque worker to cache facebook data.</p>

<figure class='code'><figcaption><span>app/workers/facebook_data_cacher.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">FacebookDataCacher</span>
</span><span class='line'>  <span class="vi">@queue</span> <span class="o">=</span> <span class="ss">:facebook_cache_data_queue</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span> <span class="n">user_id</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">facebook_data_cached_at</span> <span class="o">&lt;</span> <span class="no">APP_CONFIG</span><span class="o">.</span><span class="n">facebook</span><span class="o">.</span><span class="n">cache_expiry_time</span><span class="o">.</span><span class="n">ago</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">cache_facebook_data?</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span> <span class="ss">:facebook_data_cached_at</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we go. The code above will get us the data we defined on our model and it will be updating and adding more data when user logins.
Now it&rsquo;s time to make decisions!!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Creating Activity Cal-heatmap Using Public_activity and Mongoid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-02T16:52:00+03:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2013</time>
        
           | <a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://dl.dropbox.com/u/47336405/Selection_043.png" title="" ></p>

<p>I had to present activites of a service provider to it&rsquo;s users in a unique way.
First thought of creating an activity stream but knew that the users won&rsquo;t be
reading them since the activity would be about the services of the provider- not something &ldquo;social&rdquo;.
Then thought of creating a line graph that shows the days and works done by the provider. It wouldn&rsquo;t be unique though.
I thought and thought by looking at my github dashboard and idea came up. I always liked Github&rsquo;s collaboration heatmap.
It was unique and concise. So I decided to create my own activity heatmap.</p>

<p>I needed to sort out three things in order to make it happen.</p>

<p>Finding out a github-like heatmap to present activities
Logging provider activites in a way that I can present on map
Making mongoid and Rails 4 work with heatmap and activity logs.</p>

<p>Here is how I created my activity heatmap:</p>

<p>Kamisama has done great job on creating cal-heatmaps. Its obvious that github uses his work too. You can find his work on
<a href="https://github.com/kamisama/cal-heatmap.">https://github.com/kamisama/cal-heatmap.</a> You have to download cal-heatmap.js, d3.js and for localisation; moment.js does great job.
I had to present three activites to user;</p>

<p>When provider gets selected by user.
When provider returns to quote
When provider does the work</p>

<p>You cannot divide the activities to parts in cal-heatmap.
You provide timestamps with numeric values and cal-heatmap shows the data.
So I first had to fetch these three activities, count them and show them on map.
Then I would present the details once the user clicks on a cell.
So &ldquo;get_provider_counts&rdquo; counts the data in a way cal-heatmap understands,
&ldquo;get_activity gets&rdquo; the data once I click on a cell.</p>

<figure class='code'><figcaption><span>providers.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">initProviderShow = </span><span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span>
</span><span class='line'>    <span class="nv">url: </span><span class="s">&quot;/activities/get_provider_counts&quot;</span>
</span><span class='line'>    <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>    <span class="nv">data:</span>
</span><span class='line'>      <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>    <span class="nv">dataType: </span><span class="s">&quot;json&quot;</span>
</span><span class='line'>    <span class="p">).</span><span class="nx">success</span> <span class="nf">(data) -&gt;</span>
</span><span class='line'>    <span class="nx">moment</span><span class="p">.</span><span class="nx">lang</span> <span class="s">&quot;en&quot;</span>
</span><span class='line'>    <span class="nv">calendar = </span><span class="k">new</span> <span class="nx">CalHeatMap</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">calendar</span><span class="p">.</span><span class="nx">init</span>
</span><span class='line'>      <span class="nv">itemSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat&quot;</span>
</span><span class='line'>      <span class="nv">data: </span><span class="nx">data</span>
</span><span class='line'>      <span class="nv">start: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">domain: </span><span class="s">&quot;month&quot;</span>
</span><span class='line'>      <span class="nv">subDomain: </span><span class="s">&quot;day&quot;</span>
</span><span class='line'>      <span class="nv">range: </span><span class="mi">7</span>
</span><span class='line'>      <span class="nv">cellSize: </span><span class="mi">15</span>
</span><span class='line'>      <span class="nv">cellPadding: </span><span class="mi">5</span>
</span><span class='line'>      <span class="nv">domainGutter: </span><span class="mi">20</span>
</span><span class='line'>      <span class="nv">displayScale: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">previousSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-PreviousDomain-selector&quot;</span>
</span><span class='line'>      <span class="nv">nextSelector: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">calheat-NextDomain-selector&quot;</span>
</span><span class='line'>      <span class="nv">domainLabelFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s">&quot;MMMM&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">subDomainDateFormat: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span> <span class="s">&quot;LL&quot;</span>
</span><span class='line'>      <span class="nv">subDomainTitleFormat:</span>
</span><span class='line'>        <span class="nv">empty: </span><span class="s">&quot;{date} +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">no_activites</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">        filled: &quot;</span><span class="p">{</span><span class="nx">date</span><span class="p">}</span>  <span class="p">{</span><span class="nx">count</span><span class="p">}</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.has_activites&quot;</span>
</span><span class='line'>      <span class="nv">onClick: </span><span class="nf">(date) -&gt;</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
</span><span class='line'>          <span class="nv">type: </span><span class="s">&quot;GET&quot;</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/activities/get_activity&quot;</span>
</span><span class='line'>          <span class="nv">data: </span><span class="p">{</span> <span class="nv">id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nv">selected: </span><span class="nx">date</span><span class="p">}</span>
</span><span class='line'>          <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>            <span class="nv">text1= </span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="nx">text2</span> <span class="o">=</span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="nv">text3 = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nv">text1 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">selected</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span><span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.selected</span>
</span><span class='line'><span class="s">            if data.returned &gt; 0</span>
</span><span class='line'><span class="s">              text2 = data.returned + &quot;</span> <span class="s">&quot; +I18n.t &quot;</span><span class="nx">shared</span><span class="p">.</span><span class="nx">navbar</span><span class="p">.</span><span class="nx">returned</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nv">text3 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">done</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">I18n</span><span class="p">.</span><span class="nx">t</span> <span class="s">&quot;shared.navbar.done&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="nx">text1</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text2</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">text3</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="nx">text1</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text2</span> <span class="o">+</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">+</span> <span class="nx">text3</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">html</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">onClick-placeholder&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">error: </span><span class="nf">(data) -&gt;</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>      <span class="nv">legend: </span><span class="p">[</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'>        <span class="mi">3</span>
</span><span class='line'>        <span class="mi">5</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>      <span class="nv">legendColors: </span><span class="p">[</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="err">#</span><span class="s">ecf5e2&quot;</span>
</span><span class='line'>        <span class="s">&quot;</span><span class="err">#</span><span class="s">232181&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>  <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was about to store provider activities myself but then found a great gem to sort it out.
Its public_activity gem. <a href="https://github.com/pokonski/public_activity">https://github.com/pokonski/public_activity</a>
It&rsquo;s quote comprehensve and does support mongoid and Rails 4.</p>

<p>The system I&rsquo;m working on is about User creating quotes to providers.
For every quote user selects up to three providers. Provider &ldquo;returns&rdquo; back to quote and
if agrees with user, provider &ldquo;does&rdquo; the work.
So I&rsquo;m tracking the user, relation to providers collection, returned providers and providerdone.</p>

<figure class='code'><figcaption><span>Quote.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;autoinc&#39;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Quote</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Paranoia</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Slug</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Autoinc</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Geocoder</span><span class="p">:</span><span class="ss">:Model</span><span class="o">::</span><span class="no">Mongoid</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Concerns</span><span class="p">:</span><span class="ss">:GmapRoute</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Model</span>
</span><span class='line'>  <span class="n">tracked</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="n">tracked</span> <span class="ss">:params</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">:returned_providers</span> <span class="o">=&gt;</span> <span class="ss">:returned_providers</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:providerdone</span> <span class="o">=&gt;</span> <span class="ss">:providerdone</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">:providers</span> <span class="o">=&gt;</span> <span class="ss">:provider_ids</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I created a controller to store activities. Our system does not have activity streams
so this will be useful for new features too.
These two methods are for ajax requests I explained above.</p>

<figure class='code'><figcaption><span>activities_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">get_provider_counts</span>
</span><span class='line'>    <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@activities</span> <span class="o">=</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">to_i</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">seldata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">retdata</span> <span class="o">=</span><span class="p">{}</span>
</span><span class='line'>    <span class="n">donedata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">selected_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">seldata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">returned_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">retdata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">done_providers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>      <span class="n">donedata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">provider</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">count</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="n">donedata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">retdata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>    <span class="vi">@caldata</span> <span class="o">=</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">seldata</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">oldval</span><span class="p">,</span> <span class="n">newval</span><span class="o">|</span> <span class="n">newval</span> <span class="o">+</span> <span class="n">oldval</span><span class="p">}</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="vi">@caldata</span><span class="o">.</span><span class="n">to_json</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_activity</span>
</span><span class='line'>    <span class="vi">@provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">date</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:selected</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@activities</span> <span class="o">=</span> <span class="ss">PublicActivity</span><span class="p">:</span><span class="ss">:Activity</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">selected_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providers&quot;</span><span class="o">=&gt;</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.create&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">returned_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.returned_providers&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">done_providers</span> <span class="o">=</span><span class="vi">@activities</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;parameters.providerdone&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@provider</span><span class="o">.</span><span class="n">_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="ss">:created_at</span><span class="o">=&gt;</span><span class="n">date</span><span class="o">.</span><span class="n">beginning_of_day</span><span class="o">.</span><span class="n">.date</span><span class="o">.</span><span class="n">end_of_day</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;quote.update&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span> <span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:selected</span><span class="o">=&gt;</span> <span class="n">selected_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:returned</span> <span class="o">=&gt;</span><span class="n">returned_providers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span><span class="ss">:done</span><span class="o">=&gt;</span><span class="n">done_providers</span><span class="o">.</span><span class="n">count</span><span class="p">}}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Finally the view to show cal-heatmap</p>

<figure class='code'><figcaption><span>providers/show.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'><span class="nt">%div</span>
</span><span class='line'>  <span class="nf">#calheat</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;position:relative;&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="nt">%p</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-PreviousDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-left</span>
</span><span class='line'>  <span class="nt">%button</span><span class="nf">#calheat-NextDomain-selector</span><span class="nc">.btn.btn-mini</span>
</span><span class='line'>    <span class="nt">%i</span><span class="nc">.icon.icon-chevron-right</span>
</span><span class='line'>  <span class="nt">%h5</span><span class="p">{</span><span class="ss">style</span><span class="p">:</span><span class="s2">&quot;text-align: center;margin-top: -10px;&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="nf">#onClick-placeholder</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/03/two-factor-authentication-using-active-model-otp-with-mongoid/">Two Factor Authentication Using Active_model_otp With Mongoid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-07-03T05:59:00+03:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2011</time>
        
           | <a href="/blog/2011/07/03/two-factor-authentication-using-active-model-otp-with-mongoid/#disqus_thread"
             data-disqus-identifier="http://canercak.github.io/blog/2011/07/03/two-factor-authentication-using-active-model-otp-with-mongoid/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had to implement two factor authentication using a custom sms provider.
Active model OTP really helped me in generating one time use tokens.
I thought it won&rsquo;t be working with mongoid but it was easy to integrate it.
Another issue was to make user authenticated on the same page.
We just didn&rsquo;t want to direct user to another page for phone verification.
So I&rsquo;ve written some js to sort it out. It&rsquo;s a bit &ldquo;manual&rdquo; because clientsidevalidations caused problems in Rails4.
Everything gets validated both on client and server side.
Here you can see relevant parts from the code.</p>

<div><script src='https://gist.github.com/9946621.js'></script>
<noscript><pre><code>def check_verification_code
      data = {:result =&gt; false}
      if current_user.authenticate_otp(params[:verification_code], drift: 200) #drift enough for old users 
        data = {:result =&gt; true}
        session[:mobile_verified] = true
      end
      respond_to do |format|
        format.json  { render :json =&gt; data} 
      end
    end


    def sendverification
      data = {:result =&gt; false} 
      phone = validate_phone(params[:verification_phone])
      if phone.present?
        sms = Sms.new       
        if sms.send_sms([phone],APP_CONFIG.sms_from, t(&#39;verification_message&#39;) + current_user.otp_code.to_s)
          data = {:result =&gt; true} 
        end
      end
      respond_to do |format|
        format.json  { render :json =&gt; data} 
      end
    end


</code></pre></noscript></div>



</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/25/using-rails-partials-and-ink-to-create-responsive-email-templates/">Using Rails Partials and Ink to Create Responsive Email Templates</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/15/forget-about-carrierwave-and-paperclip/">Forget About Carrierwave and Paperclip, Use Transloadit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/09/using-omniauth-identity-with-jquery-clientside-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/03/collecting-user-data-to-mongoid-application-using-omniauth-facebook-and-koala/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth, Facebook, Koala and Resque</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Creating Activity Cal-heatmap Using Public_activity and Mongoid</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Caner -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'canerblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
