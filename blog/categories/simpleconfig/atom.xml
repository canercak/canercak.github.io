<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Simpleconfig | Caner's Ruby on rails blog]]></title>
  <link href="http://canercak.github.io/blog/categories/simpleconfig/atom.xml" rel="self"/>
  <link href="http://canercak.github.io/"/>
  <updated>2014-07-21T01:10:05+03:00</updated>
  <id>http://canercak.github.io/</id>
  <author>
    <name><![CDATA[Caner Cakmak]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth]]></title>
    <link href="http://canercak.github.io/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/"/>
    <updated>2014-03-20T21:06:29+02:00</updated>
    <id>http://canercak.github.io/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth</id>
    <content type="html"><![CDATA[<p>Data is the key to long-lasting relationship with users. The more, the better. Once we have relevant data; we can target marketing, develop features tailored to specific users and make users trust each other. So how do we collect relevant data? There is an easy way. It’s Facebook.</p>

<p>First, talk with your solicitor to add your Terms&amp;Conditions document that you are collecting data by using facebook. Then make a big “Login with Facebook” button on your landing page. Don’t forget to write that the user accepts the conditions once the button clicked. Something like this:</p>

<p><img class="<a" src="href="http://dl.dropbox.com/u/47336405/Selection_044.png">http://dl.dropbox.com/u/47336405/Selection_044.png</a>"></p>

<p> Then you are ready to go. I use three gems to collect data: omniauth, omniauth-facebook and koala. For config settings there is simple config and for caching data I use resque. I know that using devise could be easier. But simply, its big.(I have omniauth-identity for nonfacebook logins) So this will be different than devise’s way.</p>

<p>Here we define our facebook app details. Sensitive data is stored on local.rb file and Simpleconfig serves them to environments. Checkout simpleconfig for details.</p>

<p>``` ruby config/settings/application.rb</p>

<p>SimpleConfig.for :application do
  group :facebook do</p>

<pre><code>set :namespace, 'FACEBOOK_NAMESPACE'
set :app_id, 'FACEBOOK_APP_ID'
set :app_secret, 'FACEBOOK_SECRET'
set :scope, 'email, publish_stream, user_birthday, user_about_me, user_education_history, user_interests, user_likes, user_religion_politics, user_work_history'
set :cache_expiry_time, 7.days
</code></pre>

<p>  end</p>

<p>```</p>

<p>Here are omniauth initialization details. You can learn more about omniauth on it’s github page.</p>

<p>``` ruby config/initialisers/omniauth.rb</p>

<pre><code>OmniAuth.config.logger = Rails.logger
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :facebook,
    APP_CONFIG.facebook.app_id,
    APP_CONFIG.facebook.app_secret,
    { scope: APP_CONFIG.facebook.scope }
end
</code></pre>

<p>```</p>

<p>``` ruby</p>

<pre><code>OmniAuth.config.logger = Rails.logger
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :facebook,
    APP_CONFIG.facebook.app_id,
    APP_CONFIG.facebook.app_secret,
    { scope: APP_CONFIG.facebook.scope }
end
</code></pre>

<p>```</p>

<p>The haml view for our big facebook button.</p>

<p>``` haml  views/pages/_facebook_login.html.haml</p>

<pre><code>.hidden-phone
  = link_to auth_at_provider_path(provider: :facebook), class: 'btn btn-large btn-facebook', data: { :"no-turbolink" =&gt; true } do
    %i.icon-facebook-sign.icon-large
    = t('login_with_facebook')
%p.signin-terms
  %b= t('we_will_never_post')
  %br= t('pages.home.signin_terms', appname: APP_CONFIG.app_name, terms_link: link_to(t('terms'), :terms, :target=&gt; '_blank', data: { :"no-turbolink" =&gt; true }), policy_link: link_to(t('policy'), :policy, :target=&gt; '_blank')).html_safe
</code></pre>

<p>```</p>

<p>Necassary routes to manage sessions</p>

<p>``` ruby config/routes.rb
  # Sessions
  resources :sessions, only: [:create, :destroy]</p>

<p>  get &lsquo;auth/:provider&rsquo;, to: &lsquo;sessions#new&rsquo;, as: :auth_at_provider
  get &lsquo;auth/:provider/callback&rsquo;, to: &lsquo;sessions#create&rsquo;
  get &lsquo;auth/failure&rsquo;, to: redirect(&lsquo;/&rsquo;)
  get &lsquo;signout&rsquo;, to: &lsquo;sessions#destroy&rsquo;, as: :logout</p>

<p>```</p>

<p>Here is the user model. Removed the nonrelevant fields. As you can see I’m collecting enough data to make decisions.</p>

<p>``` ruby app/models/user.rb</p>

<pre><code>class User
  include Mongoid::Document
  include ::Concerns::User::Authentication
  include ::Concerns::User::Facebook

  field :provider
  field :uid
  field :oauth_token
  field :oauth_expires_at
  field :facebook_permissions, type: Array, default: []
  field :facebook_friends, type: Array, default: []
  field :facebook_favorites, type: Array, default: []
  field :facebook_data_cached_at, type: DateTime, default: '2014-01-01'
  field :gender
  field :username
  field :bio
  field :languages, type: Array, default: []
  field :birthday, type: Date
  field :work, type: Hash, default: {}
  field :education, type: Hash, default: {}
  field :email
  field :name
  field :facebook_verified, type: Boolean, default: false
</code></pre>

<p>```</p>

<p>Here is the module for facebook authentication. This will collect facebook user data before saving the user.</p>

<p>``` ruby app/models/concerns/authentication.rb</p>

<pre><code>module Concerns
  module User
    module Authentication
      extend ActiveSupport::Concern

      included do
        def set_fields_from_omniauth(auth)
          set_credentials auth.credentials
          set_info auth.info
          set_extra_raw_info auth.extra.raw_info
          set_extra_raw_info_special_permissions auth.extra.raw_info
          set_permissions
          Resque.enqueue(FacebookDataCacher, id)
        rescue Redis::CannotConnectError
        end

        private
        def set_credentials(credentials)
          self.oauth_token = credentials.token
          self.oauth_expires_at =  Time.at credentials.expires_at || Time.now
        end

        def set_info(info)
          self.email = info.email
          self.name = info.name
          self.facebook_verified = info.verified || false
        end
        def set_extra_raw_info(raw_info)
          self.username = raw_info.username
          self.gender = raw_info.gender
          self.bio = raw_info.bio
          self.languages = raw_info.languages || {}
        end
        def set_extra_raw_info_special_permissions(raw_info)
          self.birthday = Date.strptime(raw_info.birthday, "%m/%d/%Y").at_midnight if raw_info.birthday
          self.work = raw_info.work || {}
          self.education = raw_info.education || {}
        end
        def set_permissions
          facebook do |fb|
            self.facebook_permissions = fb.get_connections('me', 'permissions')[0]
          end
        end
      end

      module ClassMethods
        def from_omniauth(auth)
          user = where(auth.slice(:provider, :uid)).first_or_initialize
          user.provider = auth.provider
          user.uid = auth.uid
          user.set_fields_from_omniauth auth
          user.save!
          user
        end
      end
    end
  end
end
</code></pre>

<p>```</p>

<p>This module is for caching data. I’m making resque collect more and more details. We will run resque workers to get them. You can also schedule the process with resque scheduler. Checkout facebook graph api for more data to get. And checkout resque gem for details.</p>

<p>``` ruby app/models/concerns/facebook.rb</p>

<pre><code>module Concerns
  module User
    module Facebook
      extend ActiveSupport::Concern
      included do
        def facebook
          @facebook ||= Koala::Facebook::API.new(oauth_token)
          block_given? ? yield(@facebook) : @facebook
        rescue Koala::Facebook::APIError =&gt; e
          logger.info e.to_s
          nil
        end

        def has_facebook_permission?(scope)
           facebook_permissions[scope.to_s].to_i == 1 if facebook_permissions?
        end

        def cache_facebook_data?
          favorites = %w(music books movies television games activities interests)
          facebook do |fb|
            result = fb.batch do |batch_api|
              batch_api.get_connections('me', 'friends')
              favorites.each do |favorite|
                batch_api.get_connections('me', favorite)
              end
            end
            if result.any?
               self.facebook_friends = result[0] ? result[0] : []
              self.facebook_favorites = result[1] ? result[1..-1].flatten : []
              return true
            end
          end
          false
        end
      end

      module ClassMethods
      end
    end
  end
end
</code></pre>

<p>```</p>

<p>We define a resque worker to cache facebook data.</p>

<p>``` ruby app/workers/facebook_data_cacher.rb</p>

<pre><code>class FacebookDataCacher
  @queue = :facebook_cache_data_queue
  def self.perform(user_id)
    user = User.find user_id
    if user.facebook_data_cached_at &lt; APP_CONFIG.facebook.cache_expiry_time.ago.utc
      if user.cache_facebook_data?
        user.update_attribute :facebook_data_cached_at, Time.now.utc
      end
    end
  end
end
</code></pre>

<p>```</p>

<p>Here we go. The code above will get us the data we defined on our model and it will be updating and adding more data when user logins. Now it’s time to make decisions!!</p>
]]></content>
  </entry>
  
</feed>
