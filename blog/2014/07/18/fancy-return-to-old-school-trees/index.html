
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Fancy Return to Old School Trees - Caner's Ruby on rails blog</title>
  <meta name="author" content="Caner Cakmak">

  
  <meta name="description" content="Been 4-5 years since I started developing Ruby on Rails and I just don&rsquo;t remember using tree views.
Used them a lot in .NET development but &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://canercak.github.io/blog/2014/07/18/fancy-return-to-old-school-trees">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Caner's Ruby on rails blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Caner's Ruby on rails blog</a></h1>
  
    <h2>It's all about the beauty of Ruby. I'm not a "Guru", not a "Rock Star" or "Ninja" at all. But I can do every single thing I need and I enjoy so much because I'm in love with her beauty</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:canercak.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Fancy Return to Old School Trees</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-18T23:36:40+03:00" pubdate data-updated="true">Jul 18<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Been 4-5 years since I started developing Ruby on Rails and I just don&rsquo;t remember using tree views.
Used them a lot in .NET development but somehow did not after that. This reminds me the KISS principle actually.
I guess Rails with Bootstrap forms and components make us present collective data in a simple manner so we don&rsquo;t tend to
use treeviews to present things &ldquo;all-in-one&rdquo;.</p>

<p>By the way for the case I will explain now, I didn&rsquo;t use a treeview at first actually. I used select2.
I had to make a company official to select the services they offer to customers. Services had 4-level categories
and the lowest level had multiple variations. When I think of the word &ldquo;select&rdquo; in Rails, I instantly remember my friend
Select2. I feed the JSON, Select2 presents and makes the user select things.
However in this case user had to select services from ever growing thousand of services. He had to view all categories at once (obviously the top ones first),
he had to filter them and for sure he had to select multiples of services.</p>

<p>Created the JSON data at first and remotely fed it to Select2. User could see the categories, filter them and select.
Things seemed right first however there was a catch.</p>

<p>Think of google. You want to search for a wikipedia article but just can&rsquo;t find it with the keywords you write -even google has exceptional capabilities to do that.
Then you go to wikipedia, find a related category and you reach to the article by looking at its parent or child categories.
You even remember to check other categories once you see them in a a categorized list.
This was the case for selecting services. When using select2 user could filter the services he is offering and would definitely reach to them,
however he would never see the &ldquo;map&rdquo; of those thousands of categories and for sure he would not include the exact services he was offering.
I knew this could undermine the user experience so I returned to my old school friend treeview.</p>

<p>Not being mad to create mine, I had to find a js based treeview component which is free and has JSON, checkbox, selection, filtering and responsive functionality.
First checked out the popular jstree however it was useless since selecting a node would check all the child nodes.
Then after extensive research bumped up to Fancytree. It really had an ugly asp style demo page so I had some prejudice first. However once I would &ldquo;get it&rdquo;
I understood that it&rsquo;s was exceptionally well-done. I now have great respect to it.</p>

<p>Here is the result</p>

<p><img src="http://dl.dropbox.com/u/47336405/Selection_002.png"></p>

<p>And here is how I used it:</p>

<p>For embedding fancytree goto <a href="https://github.com/mar10/fancytree/wiki">https://github.com/mar10/fancytree/wiki</a></p>

<p>Basically you have include the actual js and css. If you use bootstrap include the glyph extension too.
Here is how I used FancyTree. It has checkbox and filtering functionality with highlighting and selection
unique to my taste.</p>

<figure class='code'><figcaption><span>provider.js.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">tree&quot;</span><span class="p">).</span><span class="nx">fancytree</span>
</span><span class='line'>      <span class="nv">activeVisible: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">aria: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">autoActivate: </span><span class="kc">true</span>
</span><span class='line'>      <span class="c1">#autoCollapse: true  </span>
</span><span class='line'>      <span class="nv">autoScroll: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">clickFolderMode: </span><span class="mi">3</span>
</span><span class='line'>      <span class="nv">checkbox: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">debugLevel: </span><span class="mi">0</span>
</span><span class='line'>      <span class="nv">disabled: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">generateIds: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">idPrefix: </span><span class="s">&quot;ft_&quot;</span>
</span><span class='line'>      <span class="nv">icons: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">keyboard: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">keyPathSeparator: </span><span class="s">&quot;/&quot;</span>
</span><span class='line'>      <span class="nv">minExpandLevel: </span><span class="mi">1</span>
</span><span class='line'>      <span class="nv">selectMode: </span><span class="mi">3</span>
</span><span class='line'>      <span class="nv">tabbable: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">titlesTabbable: </span><span class="kc">true</span>
</span><span class='line'>      <span class="nv">strings: </span>
</span><span class='line'>          <span class="nv">loading: </span><span class="s">&quot;yükleniyor...&quot;</span>
</span><span class='line'>          <span class="nv">loadError: </span><span class="s">&quot;yükleme başarısız&quot;</span> 
</span><span class='line'>      <span class="nv">extensions: </span><span class="p">[</span>
</span><span class='line'>          <span class="s">&quot;filter&quot;</span>
</span><span class='line'>          <span class="s">&quot;glyph&quot;</span>
</span><span class='line'>      <span class="p">]</span>
</span><span class='line'>      <span class="nv">filter:</span>
</span><span class='line'>          <span class="nv">mode: </span><span class="s">&quot;dim&quot;</span>
</span><span class='line'>      <span class="nv">source:</span>
</span><span class='line'>          <span class="nv">url: </span><span class="s">&quot;/categories/get_allcategories&quot;</span>
</span><span class='line'>          <span class="nv">data:</span>
</span><span class='line'>              <span class="nv">provider_id: </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">provider_id&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>          <span class="nv">cache: </span><span class="kc">false</span>
</span><span class='line'>      <span class="nv">onPostInit: </span><span class="nf">-&gt;</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@getSelectedNodes</span><span class="p">(),</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">makeVisible</span><span class="p">()</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="nv">select: </span><span class="nf">(e, data) -&gt;</span>
</span><span class='line'>          <span class="nv">selKeys = </span><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">getSelectedNodes</span><span class="p">(),</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">key</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">echoSelection3&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">selKeys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">selRootNodes = </span><span class="nx">data</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">getSelectedNodes</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">selRootKeys = </span><span class="nx">$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">selRootNodes</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="nx">node</span><span class="p">.</span><span class="nx">key</span>
</span><span class='line'>          <span class="p">)</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">echoSelectionRootKeys3&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">selRootKeys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="nv">click: </span><span class="nf">(event, data) -&gt;</span>
</span><span class='line'>          <span class="nv">node = </span><span class="nx">data</span><span class="p">.</span><span class="nx">node</span>
</span><span class='line'>          <span class="nv">tt = </span><span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">fancytree</span><span class="p">.</span><span class="nx">getEventTargetType</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="nx">tt</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
</span><span class='line'>              <span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>              <span class="nv">c1 = </span><span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>              <span class="k">if</span> <span class="nx">c1</span> <span class="o">!=</span> <span class="kc">null</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span> <span class="nx">c1</span><span class="p">,</span> <span class="nf">(index, v1) -&gt;</span>
</span><span class='line'>                      <span class="nx">v1</span><span class="p">.</span><span class="nx">toggleExpanded</span><span class="p">()</span>
</span><span class='line'>                      <span class="nv">c2 = </span><span class="nx">v1</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                  <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">extraClasses</span> <span class="o">is</span> <span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                       <span class="nv">data.node.extraClasses = </span><span class="s">&quot;&quot;</span>
</span><span class='line'>                  <span class="k">else</span>
</span><span class='line'>                      <span class="nv">data.node.extraClasses = </span><span class="s">&quot;fancytree-selected&quot;</span>
</span><span class='line'>              <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">rootnode = </span><span class="kc">undefined</span>
</span><span class='line'>  <span class="nv">tree = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">tree&quot;</span><span class="p">).</span><span class="nx">fancytree</span><span class="p">(</span><span class="s">&quot;getTree&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nv">n = </span><span class="kc">undefined</span>
</span><span class='line'>      <span class="nv">leavesOnly = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">leavesOnly&quot;</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">match = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">e</span> <span class="o">and</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">.</span><span class="nx">ESCAPE</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">()</span>
</span><span class='line'>          <span class="k">return</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">regex&quot;</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">n = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">filterNodes</span><span class="p">(</span><span class="nf">(node) -&gt;</span>
</span><span class='line'>              <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">).</span><span class="nx">test</span> <span class="nx">node</span><span class="p">.</span><span class="nx">title</span>
</span><span class='line'>          <span class="p">,</span> <span class="nx">leavesOnly</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nv">n = </span><span class="nx">tree</span><span class="p">.</span><span class="nx">filterNodes</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">leavesOnly</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;span</span><span class="err">#</span><span class="s">matches&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="s">&quot; eşleşme bulundu)&quot;</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">focus</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;button</span><span class="err">#</span><span class="s">btnResetSearch&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">val</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;span</span><span class="err">#</span><span class="s">matches&quot;</span><span class="p">).</span><span class="nx">text</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">hideMode&quot;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nv">tree.options.filter.mode = </span><span class="p">(</span><span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="o">is</span><span class="p">(</span><span class="s">&quot;:checked&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="s">&quot;hide&quot;</span> <span class="k">else</span> <span class="s">&quot;dimm&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>  <span class="p">).</span><span class="nx">prop</span> <span class="s">&quot;checked&quot;</span><span class="p">,</span> <span class="kc">true</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">leavesOnly&quot;</span><span class="p">).</span><span class="nx">change</span> <span class="nf">(e) -&gt;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1"># tree.options.filter.leavesOnly = $(this).is(&quot;:checked&quot;);</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input</span><span class="err">#</span><span class="s">regex&quot;</span><span class="p">).</span><span class="nx">change</span> <span class="nf">(e) -&gt;</span>
</span><span class='line'>      <span class="nx">tree</span><span class="p">.</span><span class="nx">clearFilter</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;input[name=search]&quot;</span><span class="p">).</span><span class="nx">keyup</span><span class="p">()</span>
</span><span class='line'>      <span class="k">return</span>
</span></code></pre></td></tr></table></div></figure>


<p>controller to feed JSON data</p>

<figure class='code'><figcaption><span>categories_controller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">get_allcategories</span>
</span><span class='line'>    <span class="n">provider</span> <span class="o">=</span> <span class="no">Provider</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:provider_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">categories</span> <span class="o">=</span>  <span class="no">Category</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">}</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span>  <span class="p">{</span><span class="n">render</span> <span class="ss">:json</span> <span class="o">=&gt;</span> <span class="n">data</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>JSON list of categories with provider&rsquo;s categories selected</p>

<figure class='code'><figcaption><span>category_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">describe</span> <span class="no">Category</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:provider</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:price</span><span class="p">,</span> <span class="n">variation_id</span><span class="p">:</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">workdone</span><span class="o">.</span><span class="n">provider</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:categories</span><span class="p">)</span> <span class="p">{</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_categories</span><span class="p">(</span><span class="kp">true</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">describe</span> <span class="s2">&quot;#list_provider_categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should return list of all categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should mark provider&#39;s categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">[</span><span class="ss">:selected</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>category.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">list_provider_categories</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">variation_ids</span><span class="p">,</span><span class="n">category_ids</span><span class="p">,</span><span class="n">related_categories</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span><span class="o">[]</span><span class="p">,</span><span class="o">[]</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">provider</span><span class="o">.</span><span class="n">present?</span>
</span><span class='line'>      <span class="n">variation_ids</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">category_ids</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&quot;prices.active&quot;</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:category_id</span><span class="p">)</span><span class="o">.</span><span class="n">uniq</span>
</span><span class='line'>      <span class="n">related_categories</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">find_parent_related</span><span class="p">(</span><span class="n">category_ids</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">grand_parents</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">parents</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">childrens</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="p">}</span> <span class="o">&amp;</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">ancestors</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">babies</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">Jbuilder</span><span class="o">.</span><span class="n">encode</span> <span class="k">do</span> <span class="o">|</span><span class="n">json</span><span class="o">|</span>
</span><span class='line'>      <span class="n">json</span><span class="o">.</span><span class="n">array!</span> <span class="n">grand_parents</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">grand_parent</span><span class="o">|</span>
</span><span class='line'>        <span class="n">gp_id</span> <span class="o">=</span> <span class="no">Category</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">:title</span><span class="o">=&gt;</span><span class="n">grand_parent</span><span class="p">)</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">grand_parent</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">gp_id</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">gp_id</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">grand_parent</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">parents</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">parent</span><span class="o">|</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">parent</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">parent</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">parent</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">parent</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">childrens</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">child</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">child</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">related_categories</span><span class="o">.</span><span class="n">include?</span> <span class="n">child</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">children</span>  <span class="no">Category</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:parent</span><span class="o">=&gt;</span><span class="n">child</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="ss">:title</span><span class="o">.</span><span class="n">in</span><span class="o">=&gt;</span><span class="n">babies</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span> <span class="k">do</span> <span class="o">|</span><span class="n">baby</span><span class="o">|</span>
</span><span class='line'>              <span class="n">variations</span> <span class="o">=</span> <span class="n">baby</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">variations</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">baby</span><span class="o">.</span><span class="n">title</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">baby</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">folder</span> <span class="kp">true</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">category_ids</span><span class="o">.</span><span class="n">include?</span> <span class="n">baby</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>              <span class="n">json</span><span class="o">.</span><span class="n">children</span> <span class="n">variations</span> <span class="k">do</span> <span class="o">|</span><span class="n">variation</span><span class="o">|</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">key</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                <span class="n">json</span><span class="o">.</span><span class="n">title</span> <span class="n">baby</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">variation</span><span class="o">.</span><span class="n">variation</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">variation_ids</span><span class="o">.</span><span class="n">include?</span> <span class="n">variation</span><span class="o">.</span><span class="n">_id</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">selected</span> <span class="kp">true</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">extraClasses</span> <span class="s2">&quot;fancytree-selected&quot;</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">expanded</span> <span class="kp">true</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                  <span class="n">json</span><span class="o">.</span><span class="n">selected</span> <span class="kp">false</span>
</span><span class='line'>                <span class="k">end</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The logic to update categories</p>

<figure class='code'><figcaption><span>provider.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">assign_workdones</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">selected_variations</span> <span class="o">=</span> <span class="no">ApplicationController</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">selected_variations</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>    <span class="n">active_variations</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">inactive_variations</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>       <span class="nb">self</span><span class="o">.</span><span class="n">assign_new_workdone</span><span class="p">(</span><span class="n">selected_variations</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">active_variations</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">inactive_variations</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span> <span class="k">if</span> <span class="nb">p</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kp">false</span><span class="p">}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>      <span class="n">variations_to_deactivate</span> <span class="o">=</span> <span class="p">(</span><span class="n">active_variations</span> <span class="o">+</span> <span class="n">inactive_variations</span><span class="p">)</span> <span class="o">-</span> <span class="n">selected_variations</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="nb">p</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span> <span class="k">if</span> <span class="n">variations_to_deactivate</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="nb">p</span><span class="o">.</span><span class="n">variation_id</span><span class="p">)}}</span>
</span><span class='line'>      <span class="n">selected_variations</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">var</span><span class="o">|</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!</span><span class="n">active_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">inactive_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">assign_new_workdone</span><span class="p">(</span><span class="o">[</span><span class="n">var</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>        <span class="k">elsif</span> <span class="o">!</span><span class="n">active_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">inactive_variations</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="n">price</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:&quot;prices.variation_id&quot;</span><span class="o">=&gt;</span> <span class="n">var</span><span class="p">)</span>
</span><span class='line'>          <span class="n">price</span><span class="o">.</span><span class="n">to_a</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>tests for assigning workdones</p>

<figure class='code'><figcaption><span>provider_spec.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;#assign_workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:new_categories</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">_id</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories include current categories and more categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span><span class="p">(</span><span class="ss">:max_categories</span><span class="p">)</span> <span class="p">{</span> <span class="mi">25</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:variation</span><span class="p">)</span><span class="o">.</span><span class="n">business_function</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">_id</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:result</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span> <span class="o">+</span> <span class="n">current_categories</span><span class="p">}</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:max_result</span><span class="p">)</span> <span class="p">{</span> <span class="n">max_categories</span> <span class="o">+</span> <span class="n">current_categories</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should create active workdones from new categories&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">initial_workdone_count</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories does not include the current categories&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:result</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should deactivate the categories that are not in the result array&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;assigned categories include inactive workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">let</span> <span class="p">(</span><span class="ss">:array_to_assign</span><span class="p">)</span> <span class="p">{</span> <span class="n">new_categories</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should activate the inactive workdones&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:active</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">array_to_assign</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="o">.</span><span class="n">assign_workdones</span><span class="p">(</span><span class="n">current_categories</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">workdones</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:active</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>helper method to parse categories</p>

<figure class='code'><figcaption><span>providers_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">selected_variations</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</span><span class='line'>   <span class="n">all_variations</span> <span class="o">=</span> <span class="n">categories</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;children&quot;</span><span class="o">]</span><span class="p">}}}}</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'>   <span class="n">selected_variations</span> <span class="o">=</span> <span class="n">all_variations</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="no">Moped</span><span class="o">::</span><span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">c</span><span class="o">[</span><span class="s2">&quot;key&quot;</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">[</span><span class="s2">&quot;selected&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="kp">true</span><span class="p">}</span><span class="o">.</span><span class="n">compact</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">selected_variations</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Caner Cakmak</span></span>

      








  


<time datetime="2014-07-18T23:36:40+03:00" pubdate data-updated="true">Jul 18<sup>th</sup>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/fancytree-dot-js/'>fancytree.js</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://canercak.github.io/blog/2014/07/18/fancy-return-to-old-school-trees/" data-via="" data-counturl="http://canercak.github.io/blog/2014/07/18/fancy-return-to-old-school-trees/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/" title="Previous Post: Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth">&laquo; Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/18/fancy-return-to-old-school-trees/">Fancy Return to Old School Trees</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/20/continuously-collecting-user-facebook-data-for-mongoid-application-using-omniauth/">Continuously Collecting User Facebook Data for Mongoid Application Using Omniauth</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/09/full-login-system-out-of-omniauth-identity-with-mongoid-and-jquery-validations/">Full Login System Out of Omniauth-identity With Mongoid and Jquery Validations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/02/creating-activity-cal-heatmap-using-public-activity-and-mongoid/">Creating Activity Cal-heatmap Using Public_activity and Mongoid</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/06/03/two-factor-authentication-using-active-model-otp-with-mongoid/">Two Factor Authentication Using Active_model_otp With Mongoid</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Caner Cakmak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
